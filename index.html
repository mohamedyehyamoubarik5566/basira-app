<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basira App</title>
    <link href="./bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="./style.css" rel="stylesheet">
    <link href="./home-styles.css" rel="stylesheet">
    <link href="./client-statement-2026.css" rel="stylesheet">
    <link href="./logout-style.css" rel="stylesheet">
    <link href="./report-styles.css" rel="stylesheet">
    <link rel="stylesheet" href="./update-styles.css">
    <link rel="stylesheet" href="./update-modal-styles.css">
    
    <!-- System Configuration - MUST BE FIRST -->
    <script>
        // System Configuration - Inline to ensure availability
        const SystemConfig = {
            version: {
                current: '2026.1.1',
                apiVersion: 'v1',
                schemaVersion: '1.0.0',
                lastUpdate: '2024-12-19T10:00:00Z'
            },
            system: {
                maintenanceMode: false,
                sessionTimeout: 30 * 60 * 1000
            }
        };
        
        // Make globally available
        if (typeof window !== 'undefined') {
            window.SystemConfig = SystemConfig;
        }
    </script>
    
    <!-- CryptoJS Library for Security -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Enhanced Core System Files -->
    <script src="./config.js"></script>
    <script src="./security.js"></script>
    <script src="./utils-enhanced.js"></script>
    <script src="./performance-enhanced.js"></script>
    <script src="./database-config-simple.js"></script>
    <script src="./clear-data.js"></script>

</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4>Basira App</h4>
            <p class="subtitle">نظام إدارة المبيعات المتطور</p>
        </div>
        <nav>
            <a href="#" class="nav-item active" data-section="dashboard">
                <i class="fas fa-home"></i>
                <span>الرئيسية</span>
            </a>
            <a href="#" class="nav-item" data-section="sales">
                <i class="fas fa-shopping-cart"></i>
                <span>المبيعات</span>
            </a>
            <a href="#" class="nav-item" data-section="clients">
                <i class="fas fa-users"></i>
                <span>العملاء</span>
            </a>
            <a href="#" class="nav-item" data-section="purchases">
                <i class="fas fa-shopping-bag"></i>
                <span>المشتريات</span>
            </a>
            <a href="#" class="nav-item" data-section="budget">
                <i class="fas fa-chart-pie"></i>
                <span>الميزانية المالية</span>
            </a>
            <a href="#" class="nav-item" data-section="treasury">
                <i class="fas fa-wallet"></i>
                <span>الخزينة</span>
            </a>
            <a href="#" class="nav-item" data-section="daily-report">
                <i class="fas fa-chart-bar"></i>
                <span>التقرير اليومي</span>
            </a>
            <a href="#" class="nav-item" data-section="bank">
                <i class="fas fa-university"></i>
                <span>البنوك والشيكات</span>
            </a>
            <a href="#" class="nav-item" data-section="vehicles">
                <i class="fas fa-truck"></i>
                <span>السيارات</span>
            </a>
            <a href="staff.html" class="nav-item">
                <i class="fas fa-user-tie"></i>
                <span>إدارة الموظفين</span>
            </a>
            <a href="control-panel.html" class="nav-item">
                <i class="fas fa-cogs"></i>
                <span>لوحة التحكم</span>
            </a>
            <a href="#" class="nav-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>الإعدادات</span>
            </a>
        </nav>
        
        <div class="sidebar-version">
            Powered by <a href="#" onclick="showDeveloperInfo()">البصيرة للتقنية</a> | v<span id="appVersion">1.0.0</span>
        </div>
        
        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">A</div>
                <div class="user-info">
                    <div class="name" id="currentUserName">المدير</div>
                    <div class="role" id="currentUserRole">مدير النظام</div>
                </div>
                <button class="logout-btn" onclick="logout()" title="تسجيل الخروج">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <header class="header">
            <h5 id="pageTitle">Dashboard</h5>
            <span id="currentDate"></span>
        </header>

        <div class="content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section active">
                <div class="home-container">
                    <!-- Welcome Section -->
                    <div class="welcome-section">
                        <h1 class="welcome-title">مرحباً بك في نظام البصيرة ERP</h1>
                        <p class="welcome-text">
                            نظام إدارة موارد المؤسسات المتقدم - الإصدار 2.0<br>
                            مع تحسينات الأمان والأداء والميزات المتطورة
                        </p>
                        
                        <div class="system-info">
                            <div class="info-item">
                                <div class="info-label">إصدار النظام</div>
                                <div class="info-value" id="systemVersion">2.0.1</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">آخر تحديث</div>
                                <div class="info-value">ديسمبر 2024</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">المستخدم الحالي</div>
                                <div class="info-value" id="currentUserDisplay">المدير</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">حالة النظام</div>
                                <div class="info-value" style="color: #10b981;">نشط</div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Overview -->
                    <div class="stats-overview">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-value" id="dashboardTotalSales">0 ج.م</div>
                            <div class="stat-label">إجمالي المبيعات اليوم</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-value" id="dashboardTotalClients">0</div>
                            <div class="stat-label">العملاء النشطين</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="stat-value" id="dashboardTotalOrders">0</div>
                            <div class="stat-label">الطلبات اليوم</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="stat-value" id="dashboardTotalBalance">0 ج.م</div>
                            <div class="stat-label">رصيد الخزينة</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <div class="action-card" onclick="navigateToSection('sales')">
                            <div class="action-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="action-title">إضافة مبيعة</div>
                            <div class="action-desc">إنشاء إذن مبيعة جديد</div>
                        </div>
                        
                        <div class="action-card" onclick="navigateToSection('clients')">
                            <div class="action-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="action-title">إضافة عميل</div>
                            <div class="action-desc">تسجيل عميل جديد</div>
                        </div>
                        
                        <div class="action-card" onclick="navigateToSection('treasury')">
                            <div class="action-icon">
                                <i class="fas fa-money-bill"></i>
                            </div>
                            <div class="action-title">إدارة الخزينة</div>
                            <div class="action-desc">متابعة الإيرادات والمصروفات</div>
                        </div>
                        
                        <div class="action-card" onclick="navigateToSection('daily-report')">
                            <div class="action-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="action-title">التقارير</div>
                            <div class="action-desc">عرض التقارير اليومية</div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="recent-activity">
                        <div class="activity-header">
                            <h2 class="activity-title">النشاط الأخير</h2>
                            <button class="modern-btn secondary" onclick="refreshActivity()">
                                <i class="fas fa-sync-alt"></i>
                                تحديث
                            </button>
                        </div>
                        
                        <div class="activity-list" id="recentActivityList">
                            <!-- سيتم ملء النشاط الأخير هنا -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Section -->
            <div id="sales-section" class="content-section">
                <!-- Header -->
                <div class="sales-header">
                    <div class="header-content">
                        <h1>نظام إدارة المبيعات</h1>
                        <p>إدارة أذون المبيعات والعملاء</p>
                    </div>
                    <div class="header-actions">
                        <button class="modern-btn primary" onclick="openPermissionModal()">
                            <i class="fas fa-file-plus"></i>
                            إضافة إذن
                        </button>
                        <button class="modern-btn secondary" onclick="exportData()">
                            <i class="fas fa-download"></i>
                            تصدير
                        </button>
                    </div>
                </div>

                <!-- Statistics Dashboard -->
                <div class="stats-grid">
                    <div class="stat-card revenue">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i>
                                +12%
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="totalSalesToday">0 ج.م</h2>
                            <p>إجمالي المبيعات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card meters">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-ruler-combined"></i>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i>
                                +8%
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="totalMetersToday">0 م</h2>
                            <p>إجمالي الأمتار</p>
                        </div>
                    </div>
                    
                    <div class="stat-card orders">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i>
                                +15%
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="activeTrucks">0</h2>
                            <p>عدد الطلبات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card clients">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i>
                                +5%
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="totalClients">0</h2>
                            <p>العملاء النشطين</p>
                        </div>
                    </div>
                </div>

                <!-- Advanced Controls -->
                <div class="controls-panel">
                    <div class="search-advanced">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="البحث في العملاء..." oninput="filterTable()">
                        </div>
                        <div class="filter-options">
                            <select class="modern-select" id="sortBy">
                                <option value="date">ترتيب حسب التاريخ</option>
                                <option value="amount">ترتيب حسب المبلغ</option>
                                <option value="client">ترتيب حسب العميل</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Modern Data Table -->
                <div class="data-table-container">
                    <div class="table-wrapper">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>رقم الإذن</th>
                                    <th>العميل</th>
                                    <th>رقم السيارة</th>
                                    <th>نوع المادة</th>
                                    <th>التكعيب</th>
                                    <th>سعر المتر</th>
                                    <th>سعر النقلة</th>
                                    <th>الوقت</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="salesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

    <!-- Check Modal -->
    <div class="modal-overlay" id="checkModal">
        <div class="permission-modal">
            <div class="modal-header">
                <h2 id="checkModalTitle">إضافة شيك جديد</h2>
                <button class="close-btn" onclick="closeCheckModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form class="permission-form" id="checkForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>رقم الشيك</label>
                        <input type="text" id="checkNumber" required>
                    </div>
                    
                    <div class="form-group">
                        <label>اسم البنك</label>
                        <input type="text" id="bankName" required>
                    </div>
                    
                    <div class="form-group">
                        <label>اسم العميل</label>
                        <div class="client-search-container">
                            <input type="text" id="checkClientName" required autocomplete="off" oninput="filterCheckClients()" onfocus="showCheckClientList()" onblur="hideCheckClientList()">
                            <div class="client-dropdown" id="checkClientDropdown"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>تاريخ الاستحقاق</label>
                        <input type="date" id="dueDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>مبلغ الشيك (ج.م)</label>
                        <input type="number" id="checkAmount" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ملاحظات</label>
                        <textarea id="checkNotes" rows="2" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; color: white; padding: 1rem; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeCheckModal()">إلغاء</button>
                    <button type="submit" class="save-btn">حفظ الشيك</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Client Statement Modal 2026 -->
    <div class="modal-overlay" id="clientStatementModal">
        <div class="client-statement-2026">
            <div class="statement-container">
                <!-- Header -->
                <div class="statement-header-2026">
                    <div class="header-content">
                        <div class="client-info-header">
                            <div class="client-avatar-large" id="statementClientAvatar">A</div>
                            <div class="client-details">
                                <h1 class="client-name-large" id="statementClientName">اسم العميل</h1>
                                <div class="client-subtitle">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>كشف حساب شامل</span>
                                    <span id="statementPeriod"></span>
                                </div>
                            </div>
                        </div>
                        <div class="statement-actions">
                            <button class="action-btn-2026" onclick="addPaymentToStatement()">
                                <i class="fas fa-plus"></i>
                                إضافة دفعة
                            </button>
                            <button class="action-btn-2026" onclick="printStatement()">
                                <i class="fas fa-print"></i>
                                طباعة
                            </button>
                            <button class="action-btn-2026" onclick="closeStatementModal()">
                                <i class="fas fa-times"></i>
                                إغلاق
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Balance Overview -->
                <div class="balance-overview">
                    <div class="balance-card-2026">
                        <div class="balance-icon-2026 opening">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="balance-amount" id="openingBalance">0 ج.م</div>
                        <div class="balance-label">رصيد بداية الفترة</div>
                    </div>
                    
                    <div class="balance-card-2026">
                        <div class="balance-icon-2026 sales">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="balance-amount" id="totalSalesAmount">0 ج.م</div>
                        <div class="balance-label">إجمالي المبيعات</div>
                    </div>
                    
                    <div class="balance-card-2026">
                        <div class="balance-icon-2026 payments">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <div class="balance-amount" id="totalPaymentsAmount">0 ج.م</div>
                        <div class="balance-label">إجمالي المدفوعات</div>
                    </div>
                    
                    <div class="balance-card-2026">
                        <div class="balance-icon-2026 current">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="balance-amount" id="currentBalanceAmount">0 ج.م</div>
                        <div class="balance-label">الرصيد الحالي</div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="statement-controls">
                    <div class="date-filter-2026">
                        <label><i class="fas fa-calendar"></i> من تاريخ:</label>
                        <input type="date" id="statementStartDate" class="date-input-2026">
                        <label>إلى تاريخ:</label>
                        <input type="date" id="statementEndDate" class="date-input-2026">
                        <button class="filter-btn-2026" onclick="filterStatement()">
                            <i class="fas fa-filter"></i>
                            تصفية
                        </button>
                    </div>
                </div>

                <!-- Statement Table -->
                <div class="statement-table-2026">
                    <div class="table-wrapper-2026">
                        <table class="modern-table-2026">
                            <thead>
                                <tr>
                                    <th>م</th>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>رقم الإذن</th>
                                    <th>رقم السيارة</th>
                                    <th>التكعيب</th>
                                    <th>سعر المتر</th>
                                    <th>المبلغ</th>
                                    <th>الرصيد</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="statementTableBody">
                                <!-- Statement data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="permission-modal">
            <div class="modal-header">
                <h2>إضافة دفعة</h2>
                <button class="close-btn" onclick="closePaymentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form class="permission-form" id="paymentForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>مبلغ الدفعة (ج.م)</label>
                        <input type="number" id="paymentAmount" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label>وصف الدفعة</label>
                        <input type="text" id="paymentDescription" placeholder="دفعة على الحساب" required>
                    </div>
                    
                    <div class="form-group">
                        <label>تاريخ الدفعة</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>ملاحظات</label>
                        <textarea id="paymentNotes" rows="2" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; color: white; padding: 1rem;"></textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closePaymentModal()">إلغاء</button>
                    <button type="submit" class="save-btn">حفظ الدفعة</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Statement Layout -->
    <div class="print-statement" id="printStatement" style="display: none;">
        <div class="print-header">
            <div class="company-info">
                <div class="company-logo">
                    <h1>شركة البصيرة للمقاولات</h1>
                    <p>متخصصون في توريد مواد البناء</p>
                </div>
                <div class="company-contact">
                    <p><i class="fas fa-phone"></i> هاتف: 01234567890</p>
                    <p><i class="fab fa-whatsapp"></i> واتس: 01234567890</p>
                    <p><i class="fas fa-user-tie"></i> محاسب: أحمد محمد - 01111111111</p>
                </div>
            </div>
            <div class="statement-info">
                <h2>كشف حساب عميل</h2>
                <div class="client-details">
                    <p><strong>اسم العميل:</strong> <span id="printClientName"></span></p>
                    <p><strong>فترة الكشف:</strong> <span id="printPeriod"></span></p>
                    <p><strong>تاريخ الطباعة:</strong> <span id="printDate"></span></p>
                </div>
            </div>
        </div>
        
        <div class="print-balance-summary">
            <div class="balance-row">
                <span>رصيد بداية الفترة:</span>
                <span id="printOpeningBalance">0 ج.م</span>
            </div>
            <div class="balance-row">
                <span>إجمالي المبيعات:</span>
                <span id="printTotalSales">0 ج.م</span>
            </div>
            <div class="balance-row">
                <span>إجمالي المدفوعات:</span>
                <span id="printTotalPayments">0 ج.م</span>
            </div>
            <div class="balance-row final">
                <span><strong>الرصيد النهائي:</strong></span>
                <span id="printFinalBalance"><strong>0 ج.م</strong></span>
            </div>
        </div>
        
        <div class="print-table-container">
            <!-- Table will be cloned here -->
        </div>
        
        <div class="print-footer">
            <p>تم إعداد هذا الكشف بواسطة نظام إدارة المبيعات - شركة البصيرة</p>
            <p>للمراجعة والاستفسار يرجى التواصل مع قسم المحاسبة</p>
        </div>
    </div>

    <!-- Client Modal -->
    <div class="modal-overlay" id="clientModal">
        <div class="permission-modal">
            <div class="modal-header">
                <h2 id="clientModalTitle">إضافة عميل جديد</h2>
                <button class="close-btn" onclick="closeClientModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form class="permission-form" id="clientForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>اسم العميل</label>
                        <input type="text" id="clientNameInput" required>
                    </div>
                    
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="tel" id="clientPhone">
                    </div>
                    
                    <div class="form-group">
                        <label>سعر السن (ج.م/م³)</label>
                        <input type="number" id="clientPriceSen" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label>سعر العدسة (ج.م/م³)</label>
                        <input type="number" id="clientPriceAdasa" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label>رصيد بداية الفترة (ج.م)</label>
                        <input type="number" id="clientOpeningBalance" step="0.01" placeholder="موجب = له عندي، سالب = عليه">
                        <small style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">الرقم الموجب يعني له عندك فلوس، السالب يعني عليه فلوس</small>
                    </div>
                    
                    <div class="form-group total-group">
                        <label>ملاحظات</label>
                        <textarea id="clientNotes" rows="3" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; color: white; padding: 1rem; resize: vertical;"></textarea>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeClientModal()">إلغاء</button>
                    <button type="submit" class="save-btn">حفظ العميل</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div class="modal-overlay" id="transactionModal">
        <div class="permission-modal">
            <div class="modal-header">
                <h2 id="transactionModalTitle">إضافة معاملة</h2>
                <button class="close-btn" onclick="closeTransactionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form class="permission-form" id="transactionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>الوصف</label>
                        <input type="text" id="transactionDesc" required>
                    </div>
                    
                    <div class="form-group">
                        <label>المبلغ</label>
                        <input type="number" id="transactionAmount" step="0.01" required>
                    </div>
                    
                    <div class="form-group total-group">
                        <label>النوع</label>
                        <input type="text" id="transactionType" readonly>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeTransactionModal()">إلغاء</button>
                    <button type="submit" class="save-btn">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Permission Modal -->
    <div class="modal-overlay" id="permissionModal">
        <div class="permission-modal">
            <div class="modal-header">
                <h2>إضافة إذن جديد</h2>
                <button class="close-btn" onclick="closePermissionModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form class="permission-form" id="permissionForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>اسم العميل</label>
                        <div class="client-search-container">
                            <input type="text" id="clientName" required autocomplete="off" oninput="filterClients()" onfocus="showClientList()" onblur="hideClientList()" onchange="updatePriceByClient()">
                            <div class="client-dropdown" id="clientDropdown"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>رقم الإذن</label>
                        <input type="text" id="permissionNumber" required>
                    </div>
                    
                    <div class="form-group">
                        <label>رقم السيارة</label>
                        <div class="car-input-container">
                            <input type="text" id="carNumber" required oninput="checkCarData()" onblur="loadCarData()">
                            <div class="car-status" id="carStatus"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>رقم المقطورة</label>
                        <input type="text" id="trailerNumber">
                    </div>
                    
                    <div class="form-group">
                        <label>التاريخ</label>
                        <input type="date" id="permissionDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>نوع المادة</label>
                        <input type="text" id="materialType" placeholder="مثال: رمل أبيض، زلط، عدسة" required>
                    </div>
                    
                    <div class="form-group">
                        <label>تكعيب بالمتر</label>
                        <input type="number" id="volume" step="0.01" required oninput="calculateTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label>سعر المتر</label>
                        <input type="number" id="pricePerMeter" step="0.01" required oninput="calculateTotal()" readonly>
                        <small style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">يتم تحديده تلقائياً من بيانات العميل</small>
                    </div>
                    
                    <div class="form-group total-group">
                        <label>سعر النقلة</label>
                        <div class="total-display" id="totalPrice">0.00 ج.م</div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closePermissionModal()">إلغاء</button>
                    <button type="submit" class="save-btn">حفظ الإذن</button>
                </div>
            </form>
        </div>
    </div>

            <!-- Clients Section -->
            <div id="clients-section" class="content-section">
                <!-- Clients Header -->
                <div class="clients-header">
                    <div class="header-content">
                        <h1>إدارة العملاء</h1>
                        <p>إدارة بيانات العملاء وأسعارهم للمواد المختلفة</p>
                    </div>
                    <div class="header-actions">
                        <button class="modern-btn primary" onclick="openClientModal()">
                            <i class="fas fa-user-plus"></i>
                            إضافة عميل
                        </button>
                        <button class="modern-btn secondary" onclick="exportClients()">
                            <i class="fas fa-download"></i>
                            تصدير
                        </button>
                    </div>
                </div>

                <!-- Clients Statistics -->
                <div class="clients-stats">
                    <div class="client-stat-card total">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="totalClientsCount">0</h2>
                            <p>إجمالي العملاء</p>
                        </div>
                    </div>
                    
                    <div class="client-stat-card active">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                        </div>
                        <div class="stat-content">
                            <h3 id="activeClientsCount">0</h3>
                            <p>العملاء النشطين</p>
                        </div>
                    </div>
                    
                    <div class="client-stat-card revenue">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalClientRevenue">0 ج.م</h3>
                            <p>إجمالي الإيرادات</p>
                        </div>
                    </div>
                </div>

                <!-- Clients Search -->
                <div class="clients-controls">
                    <div class="search-clients">
                        <i class="fas fa-search"></i>
                        <input type="text" id="clientsSearch" placeholder="البحث في العملاء..." oninput="searchClients()">
                    </div>
                </div>

                <!-- Clients Grid -->
                <div class="clients-grid" id="clientsGrid">
                    <!-- Clients will be populated here -->
                </div>
            </div>

            <!-- Purchases Section -->
            <div id="purchases-section" class="content-section">
                <!-- Purchases Header -->
                <div class="sales-header">
                    <div class="header-content">
                        <h1>نظام إدارة المشتريات</h1>
                        <p>إدارة أذون المشتريات والموردين</p>
                    </div>
                    <div class="header-actions">
                        <button class="modern-btn primary" onclick="openPurchaseModal()">
                            <i class="fas fa-file-plus"></i>
                            إضافة مشترى
                        </button>
                        <button class="modern-btn secondary" onclick="exportPurchases()">
                            <i class="fas fa-download"></i>
                            تصدير
                        </button>
                    </div>
                </div>

                <!-- Statistics Dashboard -->
                <div class="stats-grid">
                    <div class="stat-card revenue">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i>
                                +8%
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="totalPurchasesToday">0 ج.م</h2>
                            <p>إجمالي المشتريات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card meters">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i>
                                +5%
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="totalSuppliers">0</h2>
                            <p>الموردين النشطين</p>
                        </div>
                    </div>
                    
                    <div class="stat-card orders">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i>
                                +12%
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="totalPurchaseOrders">0</h2>
                            <p>عدد الطلبات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card clients">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-warehouse"></i>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i>
                                +3%
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="totalInventory">0 م³</h2>
                            <p>المخزون الحالي</p>
                        </div>
                    </div>
                </div>

                <!-- Advanced Controls -->
                <div class="controls-panel">
                    <div class="search-advanced">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchPurchases" placeholder="البحث في المشتريات..." oninput="filterPurchasesTable()">
                        </div>
                        <div class="filter-options">
                            <select class="modern-select" id="sortPurchasesBy">
                                <option value="date">ترتيب حسب التاريخ</option>
                                <option value="amount">ترتيب حسب المبلغ</option>
                                <option value="supplier">ترتيب حسب المورد</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Modern Data Table -->
                <div class="data-table-container">
                    <div class="table-wrapper">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>رقم الإذن</th>
                                    <th>المورد</th>
                                    <th>نوع المادة</th>
                                    <th>الكمية</th>
                                    <th>سعر الوحدة</th>
                                    <th>الإجمالي</th>
                                    <th>التاريخ</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="purchasesTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Suppliers Section -->
                <div class="suppliers-section" style="margin-top: 3rem;">
                    <div class="clients-header">
                        <div class="header-content">
                            <h1>إدارة الموردين</h1>
                            <p>إدارة بيانات الموردين وأسعارهم</p>
                        </div>
                        <div class="header-actions">
                            <button class="modern-btn primary" onclick="openSupplierModal()">
                                <i class="fas fa-user-plus"></i>
                                إضافة مورد
                            </button>
                        </div>
                    </div>

                    <!-- Suppliers Grid -->
                    <div class="clients-grid" id="suppliersGrid">
                        <!-- Suppliers will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Purchase Modal -->
            <div class="modal-overlay" id="purchaseModal">
                <div class="permission-modal">
                    <div class="modal-header">
                        <h2>إضافة مشترى جديد</h2>
                        <button class="close-btn" onclick="closePurchaseModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form class="permission-form" id="purchaseForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>اسم المورد</label>
                                <div class="client-search-container">
                                    <input type="text" id="supplierName" required autocomplete="off" oninput="filterSuppliers()" onfocus="showSupplierList()" onblur="hideSupplierList()">
                                    <div class="client-dropdown" id="supplierDropdown"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>رقم الإذن</label>
                                <input type="text" id="purchaseNumber" required>
                            </div>
                            
                            <div class="form-group">
                                <label>نوع المادة</label>
                                <select id="purchaseMaterialType" required>
                                    <option value="">اختر نوع المادة</option>
                                    <option value="سن">سن</option>
                                    <option value="عدسة">عدسة</option>
                                    <option value="زلط">زلط</option>
                                    <option value="رمل">رمل</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>الكمية</label>
                                <input type="number" id="purchaseQuantity" step="0.01" required oninput="calculatePurchaseTotal()">
                            </div>
                            
                            <div class="form-group">
                                <label>سعر الوحدة</label>
                                <input type="number" id="purchaseUnitPrice" step="0.01" required oninput="calculatePurchaseTotal()">
                            </div>
                            
                            <div class="form-group total-group">
                                <label>الإجمالي</label>
                                <div class="total-display" id="purchaseTotal">0.00 ج.م</div>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="cancel-btn" onclick="closePurchaseModal()">إلغاء</button>
                            <button type="submit" class="save-btn">حفظ المشترى</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Supplier Modal -->
            <div class="modal-overlay" id="supplierModal">
                <div class="permission-modal">
                    <div class="modal-header">
                        <h2 id="supplierModalTitle">إضافة مورد جديد</h2>
                        <button class="close-btn" onclick="closeSupplierModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form class="permission-form" id="supplierForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>اسم المورد</label>
                                <input type="text" id="supplierNameInput" required>
                            </div>
                            
                            <div class="form-group">
                                <label>رقم الهاتف</label>
                                <input type="tel" id="supplierPhone">
                            </div>
                            
                            <div class="form-group">
                                <label>العنوان</label>
                                <input type="text" id="supplierAddress">
                            </div>
                            
                            <div class="form-group total-group">
                                <label>ملاحظات</label>
                                <textarea id="supplierNotes" rows="3" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; color: white; padding: 1rem; resize: vertical;"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="cancel-btn" onclick="closeSupplierModal()">إلغاء</button>
                            <button type="submit" class="save-btn">حفظ المورد</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Budget Section -->
            <div id="budget-section" class="content-section">
                <!-- Budget Header -->
                <div class="budget-header">
                    <div class="header-content">
                        <h1>الميزانية المالية</h1>
                        <p>لوحة تحكم مالية متقدمة 2026</p>
                    </div>
                    <div class="header-actions">
                        <button class="modern-btn primary" onclick="generateCEOReport()">
                            <i class="fas fa-file-pdf"></i>
                            تقرير المدير التنفيذي
                        </button>
                        <button class="modern-btn secondary" onclick="exportBudgetData()">
                            <i class="fas fa-download"></i>
                            تصدير
                        </button>
                    </div>
                </div>

                <!-- Main Financial Dashboard -->
                <div class="financial-overview">
                    <div class="financial-card assets">
                        <div class="card-glow"></div>
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="card-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                +15.2%
                            </div>
                        </div>
                        <div class="card-content">
                            <h2 id="totalAssets">0 ج.م</h2>
                            <p>إجمالي الأصول</p>
                            <div class="card-details">
                                <span>نقدية + بنوك + ذمم عملاء</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="financial-card liabilities">
                        <div class="card-glow"></div>
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="card-trend negative">
                                <i class="fas fa-arrow-down"></i>
                                -8.5%
                            </div>
                        </div>
                        <div class="card-content">
                            <h2 id="totalLiabilities">0 ج.م</h2>
                            <p>إجمالي الخصوم</p>
                            <div class="card-details">
                                <span>ديون موردين + رواتب معلقة</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="financial-card networth">
                        <div class="card-glow"></div>
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="card-trend positive">
                                <i class="fas fa-arrow-up"></i>
                                +22.8%
                            </div>
                        </div>
                        <div class="card-content">
                            <h2 id="netWorth">0 ج.م</h2>
                            <p>صافي الثروة</p>
                            <div class="card-details">
                                <span>الأصول - الخصوم</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis Sections -->
                <div class="analysis-grid">
                    <!-- Client Aging Analysis -->
                    <div class="analysis-card aging">
                        <div class="analysis-header">
                            <h3>تحليل أعمار العملاء</h3>
                            <div class="analysis-icon">
                                <i class="fas fa-user-clock"></i>
                            </div>
                        </div>
                        <div class="aging-list" id="clientAging">
                            <!-- Client aging data will be populated here -->
                        </div>
                    </div>

                    <!-- Inventory Value -->
                    <div class="analysis-card inventory">
                        <div class="analysis-header">
                            <h3>قيمة المخزون</h3>
                            <div class="analysis-icon">
                                <i class="fas fa-warehouse"></i>
                            </div>
                        </div>
                        <div class="inventory-stats">
                            <div class="inventory-item">
                                <span class="label">مباع اليوم:</span>
                                <span class="value" id="soldToday">0 م³</span>
                            </div>
                            <div class="inventory-item">
                                <span class="label">مشترى اليوم:</span>
                                <span class="value" id="purchasedToday">0 م³</span>
                            </div>
                            <div class="inventory-item balance">
                                <span class="label">الرصيد:</span>
                                <span class="value" id="inventoryBalance">0 م³</span>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Chart -->
                    <div class="analysis-card chart">
                        <div class="analysis-header">
                            <h3>توزيع الإيرادات</h3>
                            <div class="analysis-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenueChart" width="300" height="300"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color sen"></div>
                                <span>سن</span>
                                <span id="senPercentage">0%</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color adasa"></div>
                                <span>عدسة</span>
                                <span id="adasaPercentage">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Financial Health Indicators -->
                <div class="health-indicators">
                    <div class="indicator-card liquidity">
                        <div class="indicator-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="indicator-content">
                            <h4>نسبة السيولة</h4>
                            <div class="indicator-value" id="liquidityRatio">0%</div>
                            <div class="indicator-status good">جيد</div>
                        </div>
                    </div>
                    
                    <div class="indicator-card debt">
                        <div class="indicator-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="indicator-content">
                            <h4>نسبة الديون</h4>
                            <div class="indicator-value" id="debtRatio">0%</div>
                            <div class="indicator-status moderate">معتدل</div>
                        </div>
                    </div>
                    
                    <div class="indicator-card profitability">
                        <div class="indicator-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="indicator-content">
                            <h4>هامش الربح</h4>
                            <div class="indicator-value" id="profitMargin">0%</div>
                            <div class="indicator-status excellent">ممتاز</div>
                        </div>
                    </div>
                    
                    <div class="indicator-card growth">
                        <div class="indicator-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div class="indicator-content">
                            <h4>معدل النمو</h4>
                            <div class="indicator-value" id="growthRate">0%</div>
                            <div class="indicator-status good">نمو مستقر</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Treasury Section -->
            <div id="treasury-section" class="content-section">
                <!-- Treasury Header -->
                <div class="treasury-header">
                    <div class="header-content">
                        <h1>إدارة الخزينة</h1>
                        <p>متابعة الإيرادات والمصروفات والأرصدة</p>
                    </div>
                    <div class="header-actions">
                        <button class="modern-btn primary" onclick="openTransactionModal('income')">
                            <i class="fas fa-plus-circle"></i>
                            إيراد
                        </button>
                        <button class="modern-btn secondary" onclick="openTransactionModal('expense')">
                            <i class="fas fa-minus-circle"></i>
                            مصروف
                        </button>
                    </div>
                </div>

                <!-- Treasury Statistics -->
                <div class="treasury-stats">
                    <div class="balance-card main-balance">
                        <div class="balance-header">
                            <div class="balance-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="balance-trend">
                                <i class="fas fa-arrow-up"></i>
                                +2.5%
                            </div>
                        </div>
                        <div class="balance-content">
                            <h2 id="totalBalance">0 ج.م</h2>
                            <p>الرصيد الإجمالي</p>
                        </div>
                    </div>
                    
                    <div class="balance-card income">
                        <div class="balance-header">
                            <div class="balance-icon">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                        </div>
                        <div class="balance-content">
                            <h3 id="totalIncome">0 ج.م</h3>
                            <p>إجمالي الإيرادات</p>
                        </div>
                    </div>
                    
                    <div class="balance-card expense">
                        <div class="balance-header">
                            <div class="balance-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                        </div>
                        <div class="balance-content">
                            <h3 id="totalExpense">0 ج.م</h3>
                            <p>إجمالي المصروفات</p>
                        </div>
                    </div>
                </div>

                <!-- Transaction Controls -->
                <div class="transaction-controls">
                    <div class="filter-tabs">
                        <button class="tab-btn active" onclick="filterTransactions('all')">الكل</button>
                        <button class="tab-btn" onclick="filterTransactions('income')">الإيرادات</button>
                        <button class="tab-btn" onclick="filterTransactions('expense')">المصروفات</button>
                    </div>
                    <div class="search-transaction">
                        <i class="fas fa-search"></i>
                        <input type="text" id="transactionSearch" placeholder="البحث في المعاملات..." oninput="searchTransactions()">
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="transactions-container">
                    <div class="transactions-wrapper">
                        <table class="transactions-table">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>الوصف</th>
                                    <th>المبلغ</th>
                                    <th>الرصيد</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Vehicles Section -->
            <div id="vehicles-section" class="content-section">
                <!-- Vehicles Header -->
                <div class="vehicles-header">
                    <div class="header-content">
                        <h1>بيانات السيارات</h1>
                        <p>جدول ذكي يجمع بيانات السيارات من الأذون تلقائياً</p>
                    </div>
                    <div class="header-actions">
                        <button class="modern-btn secondary" onclick="exportVehicles()">
                            <i class="fas fa-download"></i>
                            تصدير
                        </button>
                        <button class="modern-btn primary" onclick="refreshVehicleData()">
                            <i class="fas fa-sync-alt"></i>
                            تحديث
                        </button>
                    </div>
                </div>

                <!-- Vehicles Statistics -->
                <div class="vehicles-stats">
                    <div class="vehicle-stat-card total">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i>
                                +5%
                            </div>
                        </div>
                        <div class="stat-content">
                            <h2 id="totalVehicles">0</h2>
                            <p>إجمالي السيارات</p>
                        </div>
                    </div>
                    
                    <div class="vehicle-stat-card active">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-play-circle"></i>
                            </div>
                        </div>
                        <div class="stat-content">
                            <h3 id="activeVehicles">0</h3>
                            <p>السيارات النشطة</p>
                        </div>
                    </div>
                    
                    <div class="vehicle-stat-card trips">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-route"></i>
                            </div>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalTrips">0</h3>
                            <p>إجمالي الرحلات</p>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Controls -->
                <div class="vehicle-controls">
                    <div class="filter-options">
                        <button class="filter-btn active" onclick="filterVehicles('all')">الكل</button>
                        <button class="filter-btn" onclick="filterVehicles('active')">النشطة</button>
                        <button class="filter-btn" onclick="filterVehicles('inactive')">غير نشطة</button>
                    </div>
                    <div class="search-vehicle">
                        <i class="fas fa-search"></i>
                        <input type="text" id="vehicleSearch" placeholder="البحث في السيارات..." oninput="searchVehicles()">
                    </div>
                </div>

                <!-- Vehicles Table -->
                <div class="vehicles-table-container">
                    <div class="table-wrapper">
                        <table class="vehicles-table">
                            <thead>
                                <tr>
                                    <th>المسلسل</th>
                                    <th>التاريخ</th>
                                    <th>رقم السيارة</th>
                                    <th>رقم المقطورة</th>
                                    <th>التكعيب</th>
                                    <th>اسم العميل</th>
                                    <th>عدد الرحلات</th>
                                    <th>آخر تحديث</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Update Notifications -->
                <div class="update-notifications" id="updateNotifications"></div>
            </div>

            <!-- Daily Report Section -->
            <div id="daily-report-section" class="content-section">
                <!-- Report Header -->
                <div class="report-header">
                    <div class="header-content">
                        <h1>التقرير اليومي للمبيعات</h1>
                        <p>تقرير شامل بأنواع المواد المختلفة</p>
                    </div>
                    <div class="header-actions">
                        <button class="modern-btn primary" onclick="generateDailyReport()">
                            <i class="fas fa-sync-alt"></i>
                            تحديث التقرير
                        </button>
                        <button class="modern-btn secondary" onclick="printDailyReport()">
                            <i class="fas fa-print"></i>
                            طباعة
                        </button>
                    </div>
                </div>

                <!-- Report Date Range -->
                <div class="report-controls">
                    <div class="date-range">
                        <label>من تاريخ:</label>
                        <input type="date" id="reportStartDate" class="date-input">
                        <label>إلى تاريخ:</label>
                        <input type="date" id="reportEndDate" class="date-input">
                        <button class="modern-btn primary" onclick="filterReportByDate()">
                            <i class="fas fa-filter"></i>
                            تصفية
                        </button>
                    </div>
                </div>

                <!-- Daily Report Table -->
                <div class="daily-report-container" id="dailyReportContainer">
                    <div class="report-table-wrapper">
                        <table class="daily-report-table professional-report-table" id="dailyReportTable">
                            <thead>
                                <tr>
                                    <th rowspan="2" class="client-header">العميل</th>
                                    <th colspan="2" class="price-header">سعر المتر</th>
                                    <th colspan="2" class="meters-header">إجمالي الأمتار</th>
                                    <th rowspan="2" class="total-header">إجمالي المبلغ</th>
                                </tr>
                                <tr>
                                    <th class="sen-header">سن</th>
                                    <th class="adasa-header">عدسة</th>
                                    <th class="sen-header">سن</th>
                                    <th class="adasa-header">عدسة</th>
                                </tr>
                            </thead>
                            <tbody id="dailyReportBody">
                                <!-- Report data will be populated here -->
                            </tbody>
                            <tfoot id="dailyReportFooter">
                                <!-- Totals row will be added here -->
                            </tfoot>
                        </table>
                    </div>
                </div>


            </div>

            <!-- Bank & Check Management Section -->
            <div id="bank-section" class="content-section">
                <!-- Bank Header -->
                <div class="bank-header">
                    <div class="header-content">
                        <h1>إدارة البنوك والشيكات</h1>
                        <p>نظام متقدم لمتابعة الشيكات ومواعيد الاستحقاق</p>
                    </div>
                    <div class="header-actions">
                        <button class="modern-btn primary" onclick="openCheckModal()">
                            <i class="fas fa-plus-circle"></i>
                            إضافة شيك
                        </button>
                        <button class="modern-btn secondary" onclick="exportChecks()">
                            <i class="fas fa-download"></i>
                            تصدير
                        </button>
                    </div>
                </div>

                <!-- Financial Dashboard -->
                <div class="financial-dashboard">
                    <div class="dashboard-card total-checks">
                        <div class="dashboard-icon">
                            <i class="fas fa-money-check"></i>
                        </div>
                        <div class="dashboard-content">
                            <h2 id="totalChecksValue">0 ج.م</h2>
                            <p>إجمالي قيمة الشيكات</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card due-today">
                        <div class="dashboard-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="dashboard-content">
                            <h3 id="dueTodayValue">0 ج.م</h3>
                            <p>مستحق اليوم</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card due-week">
                        <div class="dashboard-icon">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <div class="dashboard-content">
                            <h3 id="dueWeekValue">0 ج.م</h3>
                            <p>مستحق هذا الأسبوع</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card cleared">
                        <div class="dashboard-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="dashboard-content">
                            <h3 id="clearedValue">0 ج.م</h3>
                            <p>تم الصرف</p>
                        </div>
                    </div>
                </div>

                <!-- Check Controls -->
                <div class="check-controls">
                    <div class="filter-tabs">
                        <button class="tab-btn active" onclick="filterChecks('all')">الكل</button>
                        <button class="tab-btn" onclick="filterChecks('pending')">مستحق لاحقاً</button>
                        <button class="tab-btn" onclick="filterChecks('due-today')">مستحق اليوم</button>
                        <button class="tab-btn" onclick="filterChecks('cleared')">تم الصرف</button>
                    </div>
                    <div class="search-check">
                        <i class="fas fa-search"></i>
                        <input type="text" id="checkSearch" placeholder="البحث في الشيكات..." oninput="searchChecks()">
                    </div>
                </div>

                <!-- Checks Table -->
                <div class="checks-container">
                    <div class="checks-wrapper">
                        <table class="checks-table">
                            <thead>
                                <tr>
                                    <th>رقم الشيك</th>
                                    <th>اسم البنك</th>
                                    <th>اسم العميل</th>
                                    <th>تاريخ الاستحقاق</th>
                                    <th>المبلغ</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="checksTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Client Statement Section -->
            <div id="client-statement-section" class="content-section">
                <!-- Statement Header -->
                <div class="statement-page-header">
                    <div class="company-branding">
                        <h1>شركة البصيرة للمقاولات</h1>
                        <p>متخصصون في توريد مواد البناء</p>
                        <div class="contact-info">
                            <span><i class="fas fa-phone"></i> 01234567890</span>
                            <span><i class="fab fa-whatsapp"></i> 01234567890</span>
                            <span><i class="fas fa-user-tie"></i> محاسب: أحمد محمد</span>
                        </div>
                    </div>
                    <div class="statement-title">
                        <h2>كشف حساب عميل</h2>
                        <div class="client-info">
                            <h3 id="statementPageClientName">اسم العميل</h3>
                            <p id="statementPageDate">تاريخ الكشف</p>
                        </div>
                    </div>
                </div>

                <!-- Balance Cards -->
                <div class="balance-cards-grid">
                    <div class="balance-card-large opening">
                        <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
                        <div class="card-content">
                            <h3 id="pageOpeningBalance">0 ج.م</h3>
                            <p>رصيد بداية الفترة</p>
                        </div>
                    </div>
                    <div class="balance-card-large sales">
                        <div class="card-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="card-content">
                            <h3 id="pageTotalSales">0 ج.م</h3>
                            <p>إجمالي المبيعات</p>
                        </div>
                    </div>
                    <div class="balance-card-large payments">
                        <div class="card-icon"><i class="fas fa-money-bill"></i></div>
                        <div class="card-content">
                            <h3 id="pageTotalPayments">0 ج.م</h3>
                            <p>إجمالي المدفوعات</p>
                        </div>
                    </div>
                    <div class="balance-card-large current">
                        <div class="card-icon"><i class="fas fa-balance-scale"></i></div>
                        <div class="card-content">
                            <h3 id="pageCurrentBalance">0 ج.م</h3>
                            <p>الرصيد الحالي</p>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="statement-page-controls">
                    <div class="date-controls">
                        <label>من تاريخ:</label>
                        <input type="date" id="pageStartDate" class="date-input">
                        <label>إلى تاريخ:</label>
                        <input type="date" id="pageEndDate" class="date-input">
                        <button class="modern-btn primary" onclick="filterPageStatement()">
                            <i class="fas fa-filter"></i>
                            تصفية
                        </button>
                    </div>
                    <div class="action-controls">
                        <button class="modern-btn secondary" onclick="addPagePayment()">
                            <i class="fas fa-plus"></i>
                            إضافة دفعة
                        </button>
                        <button class="modern-btn primary" onclick="printPageStatement()">
                            <i class="fas fa-print"></i>
                            طباعة
                        </button>
                        <button class="modern-btn secondary" onclick="backToClients()">
                            <i class="fas fa-arrow-right"></i>
                            العودة للعملاء
                        </button>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="statement-page-table">
                    <table class="professional-table">
                        <thead>
                            <tr>
                                <th>م</th>
                                <th>التاريخ</th>
                                <th>رقم الإذن</th>
                                <th>رقم السيارة</th>
                                <th>رقم المقطورة</th>
                                <th>التكعيب</th>
                                <th>سعر المتر</th>
                                <th>سعر النقلة</th>
                                <th>الرصيد</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="pageStatementTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings-section" class="content-section">
                <div class="card">
                    <div class="card-body">
                        <h6>الإعدادات</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Script -->
    <script src="./script-main.js"></script>
    <script src="./script-functions.js"></script>
    
</body>
</html>
        
        // Security: Input sanitization function
        function sanitizeInput(input) {
            if (typeof input !== 'string') return '';
            return input
                .replace(/[<>"'&]/g, function(match) {
                    const map = {
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#x27;',
                        '&': '&amp;'
                    };
                    return map[match];
                })
                .trim()
                .substring(0, 200); // Limit length
        }
        
        // Enhanced error handling for DOM elements
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }
        
        // Security Check and User Info
        document.addEventListener('DOMContentLoaded', function() {
            const session = localStorage.getItem('currentUser');
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            
            // Update user info in sidebar
            try {
                const user = JSON.parse(session);
                document.getElementById('currentUserName').textContent = user.companyName || user.username || 'المستخدم';
                document.getElementById('currentUserRole').textContent = user.role === 'admin' ? 'مدير النظام' : 
                    user.role === 'developer' ? 'مطور' : 'مدير الشركة';
                
                // Update company branding
                if (user.companyName) {
                    document.querySelector('.sidebar-header h4').textContent = user.companyName;
                    document.querySelector('.sidebar-header .subtitle').textContent = 'نظام إدارة الموارد';
                }
            } catch (e) {
                console.error('Error parsing user session:', e);
            }
        });
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('currentUser');
            localStorage.removeItem('lastCompanyCode');
            showNotification('تم تسجيل الخروج بنجاح');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1000);
        }
        
        // Make logout function globally available
        window.logout = logout;
        
        // Update version display
        document.addEventListener('DOMContentLoaded', function() {
            const versionElement = document.getElementById('appVersion');
            if (versionElement) {
                // Wait for SystemConfig to be available
                if (typeof SystemConfig !== 'undefined' && SystemConfig.version) {
                    versionElement.textContent = SystemConfig.version.current || '2.0.1';
                } else {
                    versionElement.textContent = '2.0.1';
                }
            }
        });
        
        // Developer info function
        function showDeveloperInfo() {
            alert('نظام إدارة الموارد \nتطوير: شركة البصيرة للتقنية\nالإصدار: 2.0.0');
        }
        
        window.showDeveloperInfo = showDeveloperInfo;

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.onclick = (e) => {
                e.preventDefault();
                
                // Skip if it's an external link
                if (item.href && (item.href.includes('staff.html') || item.href.includes('control-panel.html'))) {
                    return;
                }
                
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                
                const section = item.dataset.section;
                if (!section) return;
                
                const sectionElement = document.getElementById(section + '-section');
                if (!sectionElement) return;
                
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                sectionElement.classList.add('active');
                document.getElementById('pageTitle').textContent = item.textContent.trim();
                
                if (section === 'sales') loadSales();
                if (section === 'purchases') loadPurchases();
                if (section === 'budget') loadBudget();
                if (section === 'treasury') loadTreasury();
                if (section === 'vehicles') loadVehicles();
                if (section === 'daily-report') loadDailyReport();
                if (section === 'bank') loadBankManagement();
                if (section === 'dashboard') loadDashboard();
                if (section === 'clients') {
                    // تحديث فوري عند فتح صفحة العملاء
                    setTimeout(() => {
                        loadClients();
                    }, 50);
                }
            };
        });

        // Date update
        function updateDate() {
            document.getElementById('currentDate').textContent = 
                new Date().toLocaleDateString('ar-EG', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
        }
        updateDate();
        
        // Initialize real-time subscriptions (disabled in localStorage mode)
        function initializeRealTime() {
            // Real-time subscriptions disabled in localStorage mode
        }
        
        // Dashboard Functions
        function loadDashboard() {
            updateDashboardStats();
            loadRecentActivity();
            updateSystemInfo();
        }
        
        function updateDashboardStats() {
            try {
                // إحصائيات المبيعات اليوم
                const {start, end} = getCurrentDayRange();
                const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
                const todayPermissions = permissions.filter(p => {
                    const date = new Date(p.date);
                    return date >= start && date < end;
                });
                
                const totalSales = todayPermissions.reduce((sum, p) => sum + parseFloat(p.totalPrice || 0), 0);
                const totalOrders = todayPermissions.length;
                
                // إحصائيات العملاء
                const clients = getClientsDatabase();
                const totalClients = Object.keys(clients).length;
                
                // رصيد الخزينة
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                const totalBalance = transactions.reduce((balance, t) => {
                    return t.type === 'income' ? balance + t.amount : balance - t.amount;
                }, 0);
                
                // تحديث العرض
                document.getElementById('dashboardTotalSales').textContent = `${totalSales.toFixed(2)} ج.م`;
                document.getElementById('dashboardTotalClients').textContent = totalClients;
                document.getElementById('dashboardTotalOrders').textContent = totalOrders;
                document.getElementById('dashboardTotalBalance').textContent = `${totalBalance.toFixed(2)} ج.م`;
                
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }
        
        function loadRecentActivity() {
            try {
                const activityList = document.getElementById('recentActivityList');
                const activities = [];
                
                // إضافة المبيعات الأخيرة
                const permissions = JSON.parse(localStorage.getItem('permissions') || '[]')
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);
                
                permissions.forEach(p => {
                    activities.push({
                        type: 'sale',
                        text: `مبيعة جديدة للعميل ${p.clientName} بقيمة ${parseFloat(p.totalPrice).toFixed(2)} ج.م`,
                        time: new Date(p.date),
                        icon: 'fas fa-shopping-cart'
                    });
                });
                
                // إضافة العملاء الجدد
                const clients = getClientsDatabase();
                Object.values(clients)
                    .filter(c => c.createdAt)
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0, 3)
                    .forEach(c => {
                        activities.push({
                            type: 'client',
                            text: `تم إضافة عميل جديد: ${c.name}`,
                            time: new Date(c.createdAt),
                            icon: 'fas fa-user-plus'
                        });
                    });
                
                // إضافة المعاملات المالية الأخيرة
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]')
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 3);
                
                transactions.forEach(t => {
                    activities.push({
                        type: 'payment',
                        text: `${t.type === 'income' ? 'إيراد' : 'مصروف'}: ${t.description} - ${t.amount.toFixed(2)} ج.م`,
                        time: new Date(t.date),
                        icon: t.type === 'income' ? 'fas fa-arrow-down' : 'fas fa-arrow-up'
                    });
                });
                
                // ترتيب النشاطات حسب الوقت
                activities.sort((a, b) => b.time - a.time);
                
                if (activities.length === 0) {
                    activityList.innerHTML = '<div class="no-activity">لا توجد أنشطة حديثة</div>';
                    return;
                }
                
                activityList.innerHTML = activities.slice(0, 8).map(activity => {
                    const timeAgo = getTimeAgo(activity.time);
                    return `
                        <div class="activity-item">
                            <div class="activity-icon ${activity.type}">
                                <i class="${activity.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-text">${activity.text}</div>
                                <div class="activity-time">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivityList').innerHTML = '<div class="no-activity">خطأ في تحميل النشاط الأخير</div>';
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'الآن';
            if (minutes < 60) return `منذ ${minutes} دقيقة`;
            if (hours < 24) return `منذ ${hours} ساعة`;
            return `منذ ${days} يوم`;
        }
        
        function updateSystemInfo() {
            try {
                const session = sessionStorage.getItem('currentUser');
                if (session) {
                    const user = JSON.parse(session);
                    document.getElementById('currentUserDisplay').textContent = user.companyName || user.username || 'المستخدم';
                }
                
                if (typeof SystemConfig !== 'undefined' && SystemConfig.version) {
                    document.getElementById('systemVersion').textContent = SystemConfig.version.current || '2.0.1';
                }
            } catch (error) {
                console.error('Error updating system info:', error);
            }
        }
        
        function navigateToSection(sectionName) {
            // إزالة الفئة النشطة من جميع العناصر
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            
            // إضافة الفئة النشطة للقسم المطلوب
            const navItem = document.querySelector(`[data-section="${sectionName}"]`);
            const section = document.getElementById(`${sectionName}-section`);
            
            if (navItem && section) {
                navItem.classList.add('active');
                section.classList.add('active');
                document.getElementById('pageTitle').textContent = navItem.textContent.trim();
                
                // تحميل بيانات القسم
                switch(sectionName) {
                    case 'sales':
                        loadSales();
                        break;
                    case 'clients':
                        setTimeout(() => loadClients(), 50);
                        break;
                    case 'treasury':
                        loadTreasury();
                        break;
                    case 'daily-report':
                        loadDailyReport();
                        break;
                }
            }
        }
        
        function refreshActivity() {
            loadRecentActivity();
            updateDashboardStats();
            showNotification('تم تحديث النشاط الأخير!');
        }
        
        // تحديث تلقائي للصفحة الرئيسية كل 30 ثانية
        let dashboardUpdateInterval;
        
        function startDashboardAutoUpdate() {
            dashboardUpdateInterval = setInterval(() => {
                if (document.getElementById('dashboard-section').classList.contains('active')) {
                    updateDashboardStats();
                    loadRecentActivity();
                }
            }, 30000); // كل 30 ثانية
        }
        
        function stopDashboardAutoUpdate() {
            if (dashboardUpdateInterval) {
                clearInterval(dashboardUpdateInterval);
            }
        }
        
        // بدء التحديث التلقائي عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            startDashboardAutoUpdate();
        });
        
        // إيقاف التحديث عند مغادرة الصفحة
        window.addEventListener('beforeunload', function() {
            stopDashboardAutoUpdate();
        });
        
        // تحسين الأمان - التحقق من صحة البيانات
        function validateDashboardData() {
            try {
                // التحقق من وجود البيانات الأساسية
                const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
                const clients = getClientsDatabase();
                const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                
                // التحقق من صحة تنسيق البيانات
                if (!Array.isArray(permissions) || !Array.isArray(transactions)) {
                    throw new Error('Invalid data format');
                }
                
                return true;
            } catch (error) {
                console.error('Dashboard data validation failed:', error);
                showNotification('خطأ في التحقق من صحة البيانات', 'error');
                return false;
            }
        }
        
        // تحسين الأداء - تخزين مؤقت للبيانات
        let dashboardCache = {
            stats: null,
            activity: null,
            lastUpdate: null
        };
        
        function getCachedDashboardData() {
            const now = Date.now();
            const cacheExpiry = 5 * 60 * 1000; // 5 دقائق
            
            if (dashboardCache.lastUpdate && (now - dashboardCache.lastUpdate) < cacheExpiry) {
                return dashboardCache;
            }
            
            return null;
        }
        
        function setCachedDashboardData(stats, activity) {
            dashboardCache = {
                stats: stats,
                activity: activity,
                lastUpdate: Date.now()
            };
        }
        
        // تم إزالة البيانات الافتراضية - البرنامج يبدأ فارغاً
        if (window.dbManager) {
            initializeRealTime();
        }
        
        // تحميل الصفحة الرئيسية عند بدء التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadDashboard();
            }, 500);
        });
        
        // Event delegation for client actions
        document.addEventListener('click', function(e) {
            if (e.target.closest('.action-btn')) {
                const btn = e.target.closest('.action-btn');
                const action = btn.getAttribute('data-action');
                const clientName = btn.getAttribute('data-client');
                
                if (action && clientName) {
                    switch(action) {
                        case 'edit':
                            editClient(clientName);
                            break;
                        case 'payment':
                            addPayment(clientName);
                            break;
                        case 'view':
                            viewClientHistory(clientName);
                            break;
                        case 'statement':
                            viewClientStatement(clientName);
                            break;
                        case 'delete':
                            deleteClient(clientName);
                            break;
                    }
                }
            }
        });
        
        // إضافة مستمع لتغيير نوع المادة بعد تحميل الصفحة
        setTimeout(() => {
            const materialTypeInput = safeGetElement('materialType');
            if (materialTypeInput) {
                materialTypeInput.addEventListener('change', function() {
                    updatePriceByClient();
                });
                materialTypeInput.addEventListener('input', function() {
                    updatePriceByClient();
                });
            }
        }, 1000);

        // Sales data management
        function getCurrentDayRange() {
            const now = new Date();
            const start = new Date(now);
            const end = new Date(now);
            
            if (now.getHours() < 8) {
                start.setDate(start.getDate() - 1);
                start.setHours(8, 0, 0, 0);
                end.setHours(8, 0, 0, 0);
            } else {
                start.setHours(8, 0, 0, 0);
                end.setDate(end.getDate() + 1);
                end.setHours(8, 0, 0, 0);
            }
            return {start, end};
        }

        async function loadSales() {
            try {
                const {start, end} = getCurrentDayRange();
                const filters = {
                    startDate: start.toISOString(),
                    endDate: end.toISOString()
                };
                
                const salesData = await dbManager.getSales(filters);
                
                // Convert Supabase format to local format for compatibility
                allTodaySales = salesData.map(sale => ({
                    id: sale.id,
                    clientName: sale.client_name,
                    permissionNumber: sale.permission_number,
                    carNumber: sale.car_number,
                    trailerNumber: sale.trailer_number,
                    materialType: sale.material_type,
                    sandType: sale.sand_type,
                    volume: sale.volume,
                    pricePerMeter: sale.price_per_meter,
                    totalPrice: sale.total_price,
                    date: sale.created_at
                }));
                
                renderTable(allTodaySales);
                updateStats();
                
            } catch (error) {
                // Error loading sales - using fallback
                // Fallback to localStorage
                const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
                const {start, end} = getCurrentDayRange();
                allTodaySales = permissions.filter(p => {
                    const date = new Date(p.date);
                    return date >= start && date < end;
                });
                
                renderTable(allTodaySales);
                updateStats();
            }
        }

        function renderTable(permissions) {
            const tbody = document.getElementById('salesTable');
            tbody.innerHTML = permissions.map((perm, i) => {
                const permTime = new Date(perm.date).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                return `
                <tr>
                    <td><span class="permission-badge">${perm.permissionNumber}</span></td>
                    <td>
                        <div class="client-info">
                            <div class="client-avatar">${perm.clientName.charAt(0).toUpperCase()}</div>
                            <span>${perm.clientName}</span>
                        </div>
                    </td>
                    <td><span class="car-number">${perm.carNumber}</span></td>
                    <td><span class="material-type">${perm.materialType || 'سن'}</span></td>
                    <td><span class="volume-display">${perm.volume} م³</span></td>
                    <td><span class="price-tag">${perm.pricePerMeter} ج.م</span></td>
                    <td><span class="total-amount">${perm.totalPrice} ج.م</span></td>
                    <td><span class="time-stamp">${permTime}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editPermission(${perm.id})" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deletePermission(${perm.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function updateStats() {
            const totalSales = allTodaySales.reduce((sum, p) => sum + parseFloat(p.totalPrice), 0);
            const totalVolume = allTodaySales.reduce((sum, p) => sum + p.volume, 0);
            const activeTrucks = allTodaySales.length;
            const uniqueClients = new Set(allTodaySales.map(p => p.clientName)).size;
            
            document.getElementById('totalSalesToday').textContent = `${totalSales.toFixed(2)} ج.م`;
            document.getElementById('totalMetersToday').textContent = `${totalVolume.toFixed(1)} م³`;
            document.getElementById('activeTrucks').textContent = activeTrucks;
            document.getElementById('totalClients').textContent = uniqueClients;
        }

        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allTodaySales.filter(sale => 
                sale.clientName.toLowerCase().includes(search) ||
                (sale.carNumber && sale.carNumber.toLowerCase().includes(search)) ||
                (sale.materialType && sale.materialType.toLowerCase().includes(search))
            );
            renderTable(filtered);
        }

        function openPermissionModal() {
            const modal = document.getElementById('permissionModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            // تعيين التاريخ الحالي كافتراضي
            document.getElementById('permissionDate').value = new Date().toISOString().split('T')[0];
        }
        
        function closePermissionModal() {
            const modal = document.getElementById('permissionModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            
            const form = document.getElementById('permissionForm');
            form.reset();
            form.removeAttribute('data-edit-id');
            
            // تعيين التاريخ الحالي كافتراضي
            document.getElementById('permissionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('totalPrice').textContent = '0.00 ج.م';
            document.getElementById('carStatus').innerHTML = '';
            document.querySelector('#permissionModal h2').textContent = 'إضافة إذن جديد';
            document.querySelector('.save-btn').textContent = 'حفظ الإذن';
        }
        
        // إغلاق النافذة عند الضغط خارجها
        document.getElementById('permissionModal').onclick = function(e) {
            if (e.target === this) {
                closePermissionModal();
            }
        };
        
        // Modal handlers with null checks
        setTimeout(() => {
            const clientPricingModal = document.getElementById('clientPricingModal');
            if (clientPricingModal) {
                clientPricingModal.onclick = function(e) {
                    if (e.target === this) {
                        closeClientPricingModal();
                    }
                };
            }
            
            const statementModal = document.getElementById('clientStatementModal');
            if (statementModal) {
                statementModal.onclick = function(e) {
                    if (e.target === this) {
                        closeStatementModal();
                    }
                };
            }
            
            const paymentModal = document.getElementById('paymentModal');
            if (paymentModal) {
                paymentModal.onclick = function(e) {
                    if (e.target === this) {
                        closePaymentModal();
                    }
                };
            }
        }, 100);
        
        // Add missing function
        function closeClientPricingModal() {
            const modal = document.getElementById('clientPricingModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }
        
        window.closeClientPricingModal = closeClientPricingModal;
        
        // إغلاق النافذة بمفتاح Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePermissionModal();
                closeClientPricingModal();
                closeClientModal();
                closeCheckModal();
            }
        });
        
        document.getElementById('clientModal').onclick = function(e) {
            if (e.target === this) {
                closeClientModal();
            }
        };

        // Clients Management Functions
        function loadClients() {
            const clients = getClientsDatabase();
            const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
            
            if (Object.keys(clients).length === 0) {
                allClients = [];
                renderClientsGrid();
                updateClientsStats();
                return;
            }
            
            allClients = Object.values(clients).map(client => {
                const clientPermissions = permissions.filter(p => p.clientName === client.name);
                const totalRevenue = clientPermissions.reduce((sum, p) => sum + parseFloat(p.totalPrice || 0), 0);
                const lastOrder = clientPermissions.length > 0 ? 
                    new Date(Math.max(...clientPermissions.map(p => new Date(p.date)))).toLocaleDateString('ar-EG') : 'لا يوجد';
                
                // حساب الرصيد الصحيح
                const openingBalance = parseFloat(client.openingBalance || 0);
                const clientPayments = getClientPayments(client.name);
                // استخدام المبيعات من الأذون مباشرة
                const currentBalance = openingBalance + totalRevenue - clientPayments;
                
                return {
                    ...client,
                    totalOrders: clientPermissions.length,
                    totalRevenue: totalRevenue,
                    lastOrder: lastOrder,
                    openingBalance: openingBalance,
                    totalPayments: clientPayments,
                    currentBalance: currentBalance,
                    isActive: clientPermissions.some(p => {
                        const orderDate = new Date(p.date);
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        return orderDate >= thirtyDaysAgo;
                    })
                };
            });
            
            renderClientsGrid();
            updateClientsStats();
        }

        function renderClientsGrid() {
            const grid = document.getElementById('clientsGrid');
            
            if (allClients.length === 0) {
                grid.innerHTML = '<div class="no-clients">لا توجد عملاء مضافين</div>';
                return;
            }
            
            grid.innerHTML = allClients.map(client => `
                <div class="client-card ${client.isActive ? 'active' : 'inactive'}">
                    <div class="client-header">
                        <div class="client-avatar">${client.name.charAt(0).toUpperCase()}</div>
                        <div class="client-info">
                            <h3>${client.name}</h3>
                            <p>${client.phone || 'لا يوجد رقم'}</p>
                        </div>
                        <div class="client-status ${client.isActive ? 'active' : 'inactive'}">
                            ${client.isActive ? 'نشط' : 'غير نشط'}
                        </div>
                    </div>
                    
                    <div class="client-pricing">
                        <div class="price-item">
                            <span class="price-label">سعر السن:</span>
                            <span class="price-value">${client.priceSen.toFixed(2)} ج.م</span>
                        </div>
                        <div class="price-item">
                            <span class="price-label">سعر العدسة:</span>
                            <span class="price-value">${client.priceAdasa.toFixed(2)} ج.م</span>
                        </div>
                    </div>
                    
                    <div class="client-balance">
                        <div class="balance-display ${client.currentBalance >= 0 ? 'positive' : 'negative'}">
                            <span class="balance-label">الرصيد الحالي:</span>
                            <span class="balance-value">${client.currentBalance.toFixed(2)} ج.م</span>
                            <span class="balance-status">${client.currentBalance >= 0 ? 'له عندي' : 'عليه'}</span>
                        </div>
                    </div>
                    
                    <div class="client-stats">
                        <div class="stat-item">
                            <span class="stat-value">${client.totalOrders}</span>
                            <span class="stat-label">طلب</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${client.totalRevenue.toFixed(0)}</span>
                            <span class="stat-label">إيرادات</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${client.lastOrder}</span>
                            <span class="stat-label">آخر طلب</span>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="action-btn edit" data-action="edit" data-client="${client.name}" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn payment" data-action="payment" data-client="${client.name}" title="إضافة دفعة">
                            <i class="fas fa-money-bill"></i>
                        </button>
                        <button class="action-btn view" data-action="view" data-client="${client.name}" title="عرض التاريخ">
                            <i class="fas fa-history"></i>
                        </button>
                        <button class="action-btn statement" data-action="statement" data-client="${client.name}" title="كشف حساب">
                            <i class="fas fa-file-invoice"></i>
                        </button>
                        <button class="action-btn delete" data-action="delete" data-client="${client.name}" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    ${client.notes ? `<div class="client-notes">${client.notes}</div>` : ''}
                </div>
            `).join('');
        }

        function updateClientsStats() {
            const totalClients = allClients.length;
            const activeClients = allClients.filter(c => c.isActive).length;
            const totalRevenue = allClients.reduce((sum, c) => sum + c.totalRevenue, 0);
            const totalBalance = allClients.reduce((sum, c) => sum + c.currentBalance, 0);
            
            document.getElementById('totalClientsCount').textContent = totalClients;
            document.getElementById('activeClientsCount').textContent = activeClients;
            document.getElementById('totalClientRevenue').textContent = totalBalance.toFixed(0) + ' ج.م';
        }



        function closeClientModal() {
            const modal = safeGetElement('clientModal');
            const form = safeGetElement('clientForm');
            
            if (modal) {
                modal.classList.remove('show');
            }
            
            document.body.style.overflow = 'auto';
            
            if (form) {
                form.reset();
                form.removeAttribute('data-edit-client');
            }
            
            // إعادة تعيين عنوان النافذة
            const modalTitle = safeGetElement('clientModalTitle');
            if (modalTitle) {
                modalTitle.textContent = 'إضافة عميل جديد';
            }
        }

        function editClient(clientName) {
            const clients = getClientsDatabase();
            const client = clients[clientName];
            
            if (client) {
                document.getElementById('clientNameInput').value = client.name;
                document.getElementById('clientPhone').value = client.phone || '';
                document.getElementById('clientPriceSen').value = client.priceSen;
                document.getElementById('clientPriceAdasa').value = client.priceAdasa;
                document.getElementById('clientOpeningBalance').value = client.openingBalance || 0;
                document.getElementById('clientNotes').value = client.notes || '';
                
                document.getElementById('clientForm').setAttribute('data-edit-client', clientName);
                document.getElementById('clientModalTitle').textContent = 'تعديل بيانات العميل';
                
                openClientModal();
            }
        }

        function deleteClient(clientName) {
            if (confirm(`هل أنت متأكد من حذف العميل "${clientName}"؟`)) {
                const clients = getClientsDatabase();
                delete clients[clientName];
                localStorage.setItem('clientsDatabase', JSON.stringify(clients));
                loadClients();
                showNotification('تم حذف العميل بنجاح!');
            }
        }

        function viewClientHistory(clientName) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector('[data-section="sales"]').classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById('sales-section').classList.add('active');
            document.getElementById('pageTitle').textContent = 'المبيعات';
            
            document.getElementById('searchInput').value = clientName;
            filterTable();
            
            showNotification(`تم عرض تاريخ العميل: ${clientName}`);
        }

        function searchClients() {
            const search = document.getElementById('clientsSearch').value.toLowerCase();
            const filteredClients = allClients.filter(client => 
                client.name.toLowerCase().includes(search) ||
                (client.phone && client.phone.includes(search))
            );
            
            const grid = document.getElementById('clientsGrid');
            if (filteredClients.length === 0) {
                grid.innerHTML = '<div class="no-clients">لا توجد نتائج مطابقة</div>';
                return;
            }
            
            const originalClients = allClients;
            allClients = filteredClients;
            renderClientsGrid();
            allClients = originalClients;
        }

        function exportClients() {
            const data = JSON.stringify(allClients, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clients-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('تم تصدير بيانات العملاء!');
        }

        document.getElementById('clientForm').onsubmit = function(e) {
            e.preventDefault();
            
            try {
                const editClient = this.getAttribute('data-edit-client');
                const clientName = sanitizeInput(document.getElementById('clientNameInput').value.trim());
                const phone = sanitizeInput(document.getElementById('clientPhone').value.trim());
                const priceSen = parseFloat(document.getElementById('clientPriceSen').value);
                const priceAdasa = parseFloat(document.getElementById('clientPriceAdasa').value);
                const openingBalance = parseFloat(document.getElementById('clientOpeningBalance').value) || 0;
                const notes = sanitizeInput(document.getElementById('clientNotes').value.trim());
                
                // التحقق من صحة البيانات
                if (!clientName || clientName.length < 2) {
                    showNotification('اسم العميل يجب أن يكون على الأقل حرفين', 'error');
                    return false;
                }
                
                if (isNaN(priceSen) || priceSen < 0 || isNaN(priceAdasa) || priceAdasa < 0) {
                    showNotification('الأسعار يجب أن تكون أرقام صحيحة وموجبة', 'error');
                    return false;
                }
                
                if (Math.abs(openingBalance) > 1000000) {
                    showNotification('رصيد البداية يجب أن يكون أقل من مليون جنيه', 'error');
                    return false;
                }
                
                const clients = getClientsDatabase();
                
                // التحقق من عدم تكرار اسم العميل
                if (!editClient && clients[clientName]) {
                    showNotification('اسم العميل موجود بالفعل', 'error');
                    return false;
                }
                
                if (editClient && editClient !== clientName) {
                    delete clients[editClient];
                }
                
                clients[clientName] = {
                    name: clientName,
                    phone: phone,
                    priceSen: priceSen,
                    priceAdasa: priceAdasa,
                    openingBalance: openingBalance,
                    notes: notes,
                    lastUpdated: new Date().toISOString(),
                    createdAt: editClient ? clients[editClient]?.createdAt : new Date().toISOString()
                };
                
                // حفظ البيانات مع معالجة الأخطاء
                const session = sessionStorage.getItem('currentUser');
                const user = session ? JSON.parse(session) : null;
                const companyCode = user?.companyCode || 'default';
                
                localStorage.setItem(`clientsDatabase_${companyCode}`, JSON.stringify(clients));
                
                closeClientModal();
                loadClients();
                showNotification(editClient ? 'تم تحديث بيانات العميل بنجاح!' : 'تم إضافة العميل بنجاح!');
                
            } catch (error) {
                console.error('Error saving client:', error);
                showNotification('حدث خطأ أثناء حفظ بيانات العميل', 'error');
            }
            
            return false;
        };
        
        function calculateTotal() {
            const volume = parseFloat(document.getElementById('volume').value) || 0;
            const price = parseFloat(document.getElementById('pricePerMeter').value) || 0;
            const total = (volume * price).toFixed(2);
            document.getElementById('totalPrice').textContent = total + ' ج.م';
        }
        
        document.getElementById('permissionForm').onsubmit = async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const editId = this.dataset.editId;
            const permissionDate = document.getElementById('permissionDate').value;
            const permission = {
                id: editId ? parseInt(editId) : Date.now(),
                client_name: document.getElementById('clientName').value,
                permission_number: document.getElementById('permissionNumber').value,
                car_number: document.getElementById('carNumber').value,
                trailer_number: document.getElementById('trailerNumber').value,
                material_type: document.getElementById('materialType').value,
                volume: parseFloat(document.getElementById('volume').value),
                price_per_meter: parseFloat(document.getElementById('pricePerMeter').value),
                total_price: (parseFloat(document.getElementById('volume').value) * parseFloat(document.getElementById('pricePerMeter').value)).toFixed(2),
                date: permissionDate ? new Date(permissionDate).toISOString() : new Date().toISOString(),
                created_at: permissionDate ? new Date(permissionDate).toISOString() : new Date().toISOString()
            };
            
            try {
                // Save to Supabase
                const savedPermission = await dbManager.saveSale(permission);
                
                // Update client pricing locally for quick access
                const materialType = permission.material_type;
                const clientName = permission.client_name;
                const price = permission.price_per_meter;
                
                if (materialType && clientName && price) {
                    const clients = getClientsDatabase();
                    if (!clients[clientName]) {
                        clients[clientName] = { 
                            name: clientName, 
                            priceSen: 0, 
                            priceAdasa: 0,
                            openingBalance: 0
                        };
                    }
                    
                    if (materialType === 'سن') {
                        clients[clientName].priceSen = price;
                    } else if (materialType === 'عدسة') {
                        clients[clientName].priceAdasa = price;
                    }
                    
                    clients[clientName].lastUpdated = new Date().toISOString();
                    localStorage.setItem('clientsDatabase', JSON.stringify(clients));
                }
                
                // Also save to localStorage for offline access
                let permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
                
                if (editId) {
                    const index = permissions.findIndex(p => p.id === parseInt(editId));
                    if (index !== -1) {
                        permissions[index] = permission;
                    }
                } else {
                    permissions.push(permission);
                }
                
                localStorage.setItem('permissions', JSON.stringify(permissions));
                
                loadSales();
                closePermissionModal();
                
            } catch (error) {
                // Error saving permission - using fallback
                // Fallback already handled in dbManager
            }
            
            return false;
        };
        
        function saveToClientAccount(permission) {
            const clientAccounts = JSON.parse(localStorage.getItem('clientAccounts') || '{}');
            if (!clientAccounts[permission.clientName]) {
                clientAccounts[permission.clientName] = [];
            }
            clientAccounts[permission.clientName].push(permission);
            localStorage.setItem('clientAccounts', JSON.stringify(clientAccounts));
        }
        
        function saveToCarData(permission) {
            const carData = JSON.parse(localStorage.getItem('carData') || '[]');
            carData.push({
                carNumber: permission.carNumber,
                trailerNumber: permission.trailerNumber,
                clientName: permission.clientName,
                lastTrip: permission.date,
                totalTrips: carData.filter(c => c.carNumber === permission.carNumber).length + 1
            });
            localStorage.setItem('carData', JSON.stringify(carData));
        }
        
        function editSale(id) {
            // Edit sale function
        }
        
        function deleteSale(id) {
            if (confirm('هل أنت متأكد من حذف هذه المبيعة؟')) {
                let sales = JSON.parse(localStorage.getItem('sales') || '[]');
                sales = sales.filter((sale, index) => (sale.id || index) !== id);
                localStorage.setItem('sales', JSON.stringify(sales));
                loadSales();
                showNotification('تم حذف المبيعة بنجاح!');
            }
        }
        
        function exportData() {
            const data = JSON.stringify(allTodaySales, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('تم تصدير البيانات بنجاح!');
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'error' ? 'rgba(239, 68, 68, 0.9)' : 
                           type === 'warning' ? 'rgba(251, 191, 36, 0.9)' : 
                           'rgba(34, 197, 94, 0.9)';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 1rem 2rem;
                border-radius: 12px;
                z-index: 9999;
                backdrop-filter: blur(10px);
                font-family: 'Cairo', sans-serif;
                font-weight: 600;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Treasury Functions

        function loadTreasury() {
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            allTransactions = transactions;
            renderTransactions(allTransactions);
            updateTreasuryStats();
        }

        function openTransactionModal(type) {
            currentTransactionType = type;
            const modal = document.getElementById('transactionModal');
            const title = document.getElementById('transactionModalTitle');
            const typeInput = document.getElementById('transactionType');
            
            title.textContent = type === 'income' ? 'إضافة إيراد' : 'إضافة مصروف';
            typeInput.value = type === 'income' ? 'إيراد' : 'مصروف';
            
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeTransactionModal() {
            const modal = document.getElementById('transactionModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            document.getElementById('transactionForm').reset();
        }

        document.getElementById('transactionForm').onsubmit = function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const transaction = {
                id: Date.now(),
                type: currentTransactionType,
                description: document.getElementById('transactionDesc').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                date: new Date().toISOString(),
                balance: calculateNewBalance(currentTransactionType, parseFloat(document.getElementById('transactionAmount').value))
            };
            
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            loadTreasury();
            closeTransactionModal();
            showNotification('تم حفظ المعاملة بنجاح!');
            return false;
        };

        function calculateNewBalance(type, amount) {
            const currentBalance = getCurrentBalance();
            return type === 'income' ? currentBalance + amount : currentBalance - amount;
        }

        function getCurrentBalance() {
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            return transactions.reduce((balance, t) => {
                return t.type === 'income' ? balance + t.amount : balance - t.amount;
            }, 0);
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactionsTable');
            tbody.innerHTML = transactions.map(t => {
                const date = new Date(t.date).toLocaleDateString('ar-EG');
                const time = new Date(t.date).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
                return `
                <tr>
                    <td><span class="date-time">${date}<br><small>${time}</small></span></td>
                    <td><span class="transaction-type ${t.type}">${t.type === 'income' ? 'إيراد' : 'مصروف'}</span></td>
                    <td>${t.description}</td>
                    <td><span class="amount ${t.type}">${t.type === 'income' ? '+' : '-'}${t.amount.toFixed(2)} ج.م</span></td>
                    <td><span class="balance">${t.balance.toFixed(2)} ج.م</span></td>
                    <td>
                        <button class="action-btn delete" onclick="deleteTransaction(${t.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function updateTreasuryStats() {
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;
            
            document.getElementById('totalBalance').textContent = `${balance.toFixed(2)} ج.م`;
            document.getElementById('totalIncome').textContent = `${totalIncome.toFixed(2)} ج.م`;
            document.getElementById('totalExpense').textContent = `${totalExpense.toFixed(2)} ج.م`;
        }

        function filterTransactions(type) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const filtered = type === 'all' ? allTransactions : allTransactions.filter(t => t.type === type);
            renderTransactions(filtered);
        }

        function searchTransactions() {
            const search = document.getElementById('transactionSearch').value.toLowerCase();
            const filtered = allTransactions.filter(t => t.description.toLowerCase().includes(search));
            renderTransactions(filtered);
        }

        function deleteTransaction(id) {
            if (confirm('هل أنت متأكد من حذف هذه المعاملة؟')) {
                let transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                transactions = transactions.filter(t => t.id !== id);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                loadTreasury();
                showNotification('تم حذف المعاملة بنجاح!');
            }
        }

        // Permission Edit/Delete Functions
        function editPermission(id) {
            const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
            const permission = permissions.find(p => p.id === id);
            
            if (permission) {
                document.getElementById('clientName').value = permission.clientName;
                document.getElementById('permissionNumber').value = permission.permissionNumber;
                document.getElementById('carNumber').value = permission.carNumber;
                document.getElementById('trailerNumber').value = permission.trailerNumber;
                document.getElementById('materialType').value = permission.materialType || '';
                document.getElementById('permissionDate').value = permission.date ? permission.date.split('T')[0] : new Date().toISOString().split('T')[0];
                document.getElementById('volume').value = permission.volume;
                document.getElementById('pricePerMeter').value = permission.pricePerMeter;
                calculateTotal();
                
                document.getElementById('permissionForm').dataset.editId = id;
                document.querySelector('#permissionModal h2').textContent = 'تعديل الإذن';
                document.querySelector('.save-btn').textContent = 'حفظ التعديل';
                
                openPermissionModal();
            }
        }

        function deletePermission(id) {
            if (confirm('هل أنت متأكد من حذف هذا الإذن؟')) {
                let permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
                permissions = permissions.filter(p => p.id !== id);
                localStorage.setItem('permissions', JSON.stringify(permissions));
                
                // Remove from client account
                const clientAccounts = JSON.parse(localStorage.getItem('clientAccounts') || '{}');
                Object.keys(clientAccounts).forEach(client => {
                    clientAccounts[client] = clientAccounts[client].filter(p => p.id !== id);
                });
                localStorage.setItem('clientAccounts', JSON.stringify(clientAccounts));
                
                loadSales();
                showNotification('تم حذف الإذن بنجاح!');
            }
        }

        // Client Search Functions
        function getUniqueClients() {
            const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
            const clients = [...new Set(permissions.map(p => p.clientName))].filter(name => name);
            return clients.sort();
        }

        function filterClients() {
            const input = document.getElementById('clientName').value.toLowerCase();
            const dropdown = document.getElementById('clientDropdown');
            const clients = getUniqueClients();
            
            if (input.length === 0) {
                dropdown.innerHTML = '';
                dropdown.style.display = 'none';
                return;
            }
            
            const filtered = clients.filter(client => 
                client.toLowerCase().startsWith(input)
            );
            
            if (filtered.length > 0) {
                dropdown.innerHTML = filtered.map(client => 
                    `<div class="client-option" onclick="selectClient('${client}')">${client}</div>`
                ).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function showClientList() {
            const input = document.getElementById('clientName').value;
            if (input.length === 0) {
                const dropdown = document.getElementById('clientDropdown');
                const clients = getUniqueClients();
                
                if (clients.length > 0) {
                    dropdown.innerHTML = clients.map(client => 
                        `<div class="client-option" onclick="selectClient('${client}')">${client}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                }
            }
        }

        function hideClientList() {
            setTimeout(() => {
                document.getElementById('clientDropdown').style.display = 'none';
            }, 200);
        }

        function selectClient(clientName) {
            document.getElementById('clientName').value = clientName;
            document.getElementById('clientDropdown').style.display = 'none';
        }

        // Car Data Management
        function checkCarData() {
            const carNumber = document.getElementById('carNumber').value.trim();
            const status = document.getElementById('carStatus');
            
            if (carNumber.length < 3) {
                status.innerHTML = '';
                return;
            }
            
            const carData = getCarData(carNumber);
            if (carData) {
                status.innerHTML = '<i class="fas fa-check-circle"></i> بيانات محفوظة';
                status.className = 'car-status found';
            } else {
                status.innerHTML = '<i class="fas fa-plus-circle"></i> سيارة جديدة';
                status.className = 'car-status new';
            }
        }

        function loadCarData() {
            const carNumber = document.getElementById('carNumber').value.trim();
            if (!carNumber) return;
            
            const carData = getCarData(carNumber);
            if (carData) {
                // تحميل بيانات السيارة المحفوظة
                if (carData.trailerNumber) {
                    document.getElementById('trailerNumber').value = carData.trailerNumber;
                }
                if (carData.defaultVolume) {
                    document.getElementById('volume').value = carData.defaultVolume;
                }
                if (carData.defaultPrice) {
                    document.getElementById('pricePerMeter').value = carData.defaultPrice;
                }
                if (carData.defaultClient && !document.getElementById('clientName').value) {
                    document.getElementById('clientName').value = carData.defaultClient;
                }
                
                calculateTotal();
                showNotification('تم تحميل بيانات السيارة!');
            }
        }

        function getCarData(carNumber) {
            const carsDatabase = JSON.parse(localStorage.getItem('carsDatabase') || '{}');
            return carsDatabase[carNumber] || null;
        }

        function saveCarToDatabase(carNumber, data) {
            const carsDatabase = JSON.parse(localStorage.getItem('carsDatabase') || '{}');
            
            if (!carsDatabase[carNumber]) {
                // سيارة جديدة
                carsDatabase[carNumber] = {
                    carNumber: carNumber,
                    trailerNumber: data.trailerNumber,
                    defaultClient: data.clientName,
                    defaultVolume: data.volume,
                    defaultPrice: data.pricePerMeter,
                    totalTrips: 1,
                    firstTrip: data.date,
                    lastTrip: data.date,
                    status: 'active'
                };
            } else {
                // تحديث بيانات موجودة
                carsDatabase[carNumber].totalTrips += 1;
                carsDatabase[carNumber].lastTrip = data.date;
                
                // تحديث القيم الافتراضية إذا لزم الأمر
                if (data.trailerNumber && !carsDatabase[carNumber].trailerNumber) {
                    carsDatabase[carNumber].trailerNumber = data.trailerNumber;
                }
            }
            
            localStorage.setItem('carsDatabase', JSON.stringify(carsDatabase));
        }

        // Vehicles Management

        function loadVehicles() {
            const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
            const vehicleMap = new Map();
            
            // تجميع بيانات السيارات من الأذون
            permissions.forEach((perm, index) => {
                const key = `${perm.carNumber}-${perm.trailerNumber || 'no-trailer'}`;
                
                if (!vehicleMap.has(key)) {
                    vehicleMap.set(key, {
                        serial: vehicleMap.size + 1,
                        carNumber: perm.carNumber,
                        trailerNumber: perm.trailerNumber || 'لا يوجد',
                        volume: perm.volume,
                        clientName: perm.clientName,
                        tripCount: 1,
                        firstDate: perm.date,
                        lastUpdate: perm.date,
                        lastPermissionId: perm.id
                    });
                } else {
                    const existing = vehicleMap.get(key);
                    existing.tripCount += 1;
                    existing.lastUpdate = perm.date;
                    existing.lastPermissionId = perm.id;
                    
                    // فحص التغييرات في البيانات
                    checkForVehicleUpdates(existing, perm);
                }
            });
            
            allVehicleRecords = Array.from(vehicleMap.values());
            renderVehiclesTable(allVehicleRecords);
            updateVehicleStats();
        }

        function renderVehiclesTable(vehicles) {
            const tbody = document.getElementById('vehiclesTableBody');
            
            if (vehicles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">لا توجد بيانات سيارات</td></tr>';
                return;
            }
            
            tbody.innerHTML = vehicles.map(vehicle => {
                const firstDate = new Date(vehicle.firstDate).toLocaleDateString('ar-EG');
                const lastUpdate = new Date(vehicle.lastUpdate).toLocaleDateString('ar-EG');
                
                return `
                <tr>
                    <td><span class="serial-badge">${vehicle.serial}</span></td>
                    <td><span class="date-display">${firstDate}</span></td>
                    <td><span class="car-number">${vehicle.carNumber}</span></td>
                    <td><span class="trailer-number">${vehicle.trailerNumber}</span></td>
                    <td><span class="volume-display">${vehicle.volume} م³</span></td>
                    <td><span class="client-name">${vehicle.clientName}</span></td>
                    <td><span class="trip-count">${vehicle.tripCount} رحلة</span></td>
                    <td><span class="last-update">${lastUpdate}</span></td>
                </tr>
            `;
            }).join('');
        }

        function updateVehicleStats() {
            const total = allVehicleRecords.length;
            const active = allVehicleRecords.filter(v => v.tripCount > 0).length;
            const totalTrips = allVehicleRecords.reduce((sum, v) => sum + v.tripCount, 0);
            
            document.getElementById('totalVehicles').textContent = total;
            document.getElementById('activeVehicles').textContent = active;
            document.getElementById('totalTrips').textContent = totalTrips;
        }

        function checkForVehicleUpdates(existing, newPerm) {
            let hasChanges = false;
            let changes = [];
            
            if (existing.volume !== newPerm.volume) {
                changes.push(`التكعيب: ${existing.volume} → ${newPerm.volume}`);
                existing.volume = newPerm.volume;
                hasChanges = true;
            }
            
            if (existing.clientName !== newPerm.clientName) {
                changes.push(`العميل: ${existing.clientName} → ${newPerm.clientName}`);
                existing.clientName = newPerm.clientName;
                hasChanges = true;
            }
            
            if (hasChanges) {
                showVehicleUpdateNotification(existing.carNumber, changes);
            }
        }
        
        function showVehicleUpdateNotification(carNumber, changes) {
            const notification = document.createElement('div');
            notification.className = 'update-notification';
            notification.innerHTML = `
                <div class="notification-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>تحديث بيانات السيارة ${carNumber}</strong>
                </div>
                <div class="notification-body">
                    ${changes.map(change => `<div>• ${change}</div>`).join('')}
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.getElementById('updateNotifications').appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
        
        function refreshVehicleData() {
            loadVehicles();
            showNotification('تم تحديث بيانات السيارات!');
        }

        function filterVehicles(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            let filtered = allVehicleRecords;
            if (type === 'active') {
                filtered = allVehicleRecords.filter(v => v.tripCount > 5);
            } else if (type === 'inactive') {
                filtered = allVehicleRecords.filter(v => v.tripCount <= 5);
            }
            renderVehiclesTable(filtered);
        }

        function searchVehicles() {
            const search = document.getElementById('vehicleSearch').value.toLowerCase();
            const filtered = allVehicleRecords.filter(v => 
                v.carNumber.toLowerCase().includes(search) ||
                v.trailerNumber.toLowerCase().includes(search) ||
                v.clientName.toLowerCase().includes(search)
            );
            renderVehiclesTable(filtered);
        }

        function exportVehicles() {
            const data = JSON.stringify(allVehicleRecords, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vehicles-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('تم تصدير بيانات السيارات!');
        }

        // Daily Report Functions

        function loadDailyReport() {
            setDefaultReportDates();
            generateDailyReport();
        }

        function setDefaultReportDates() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = todayStr;
            document.getElementById('reportEndDate').value = todayStr;
        }

        function generateDailyReport() {
            const startDate = new Date(document.getElementById('reportStartDate').value);
            const endDate = new Date(document.getElementById('reportEndDate').value);
            endDate.setHours(23, 59, 59, 999);
            
            const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
            const clients = getClientsDatabase();
            
            // Filter permissions by date range
            const filteredPermissions = permissions.filter(p => {
                const permDate = new Date(p.date);
                return permDate >= startDate && permDate <= endDate;
            });
            
            // Group by client and material type
            const reportData = {};
            
            filteredPermissions.forEach(perm => {
                const clientName = perm.clientName;
                const materialType = perm.materialType || 'سن'; // Default to سن for old data
                
                if (!reportData[clientName]) {
                    reportData[clientName] = {
                        clientName: clientName,
                        priceSen: clients[clientName]?.priceSen || 0,
                        priceAdasa: clients[clientName]?.priceAdasa || 0,
                        totalMetersSen: 0,
                        totalMetersAdasa: 0,
                        totalAmountSen: 0,
                        totalAmountAdasa: 0
                    };
                }
                
                const volume = parseFloat(perm.volume) || 0;
                
                if (materialType === 'سن') {
                    reportData[clientName].totalMetersSen += volume;
                    reportData[clientName].totalAmountSen += volume * reportData[clientName].priceSen;
                } else if (materialType === 'عدسة') {
                    reportData[clientName].totalMetersAdasa += volume;
                    reportData[clientName].totalAmountAdasa += volume * reportData[clientName].priceAdasa;
                }
            });
            
            dailyReportData = Object.values(reportData).filter(client => 
                client.totalMetersSen > 0 || client.totalMetersAdasa > 0
            );
            
            renderDailyReportTable();
        }

        function renderDailyReportTable() {
            const tbody = document.getElementById('dailyReportBody');
            const tfoot = document.getElementById('dailyReportFooter');
            
            if (dailyReportData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data-cell">لا توجد بيانات للفترة المحددة</td></tr>';
                tfoot.innerHTML = '';
                return;
            }
            
            // Render client rows
            tbody.innerHTML = dailyReportData.map((client, index) => {
                const grandTotal = client.totalAmountSen + client.totalAmountAdasa;
                return `
                <tr class="data-row ${index % 2 === 0 ? 'even' : 'odd'}">
                    <td class="client-name-cell">${client.clientName}</td>
                    <td class="price-cell sen-price">${client.priceSen.toFixed(2)}</td>
                    <td class="price-cell adasa-price">${client.priceAdasa.toFixed(2)}</td>
                    <td class="meters-cell sen-meters">${client.totalMetersSen.toFixed(2)}</td>
                    <td class="meters-cell adasa-meters">${client.totalMetersAdasa.toFixed(2)}</td>
                    <td class="total-cell grand-total">${grandTotal.toFixed(2)} ج.م</td>
                </tr>
            `;
            }).join('');
            
            // Calculate totals
            const totalMetersSen = dailyReportData.reduce((sum, client) => sum + client.totalMetersSen, 0);
            const totalMetersAdasa = dailyReportData.reduce((sum, client) => sum + client.totalMetersAdasa, 0);
            const totalAmountSen = dailyReportData.reduce((sum, client) => sum + client.totalAmountSen, 0);
            const totalAmountAdasa = dailyReportData.reduce((sum, client) => sum + client.totalAmountAdasa, 0);
            const grandTotalAmount = totalAmountSen + totalAmountAdasa;
            
            // Render totals row
            tfoot.innerHTML = `
                <tr class="totals-row">
                    <td class="totals-label"><strong>الإجمالي</strong></td>
                    <td class="totals-dash">-</td>
                    <td class="totals-dash">-</td>
                    <td class="totals-meters"><strong>${totalMetersSen.toFixed(2)} م</strong></td>
                    <td class="totals-meters"><strong>${totalMetersAdasa.toFixed(2)} م</strong></td>
                    <td class="totals-amount"><strong>${grandTotalAmount.toFixed(2)} ج.م</strong></td>
                </tr>
            `;
        }

        function filterReportByDate() {
            generateDailyReport();
            showNotification('تم تحديث التقرير بنجاح!');
        }

        function printDailyReport() {
            window.print();
        }

        // Client Database Functions
        function getClientsDatabase() {
            const session = sessionStorage.getItem('currentUser');
            const user = session ? JSON.parse(session) : null;
            const companyCode = user?.companyCode || 'default';
            return JSON.parse(localStorage.getItem(`clientsDatabase_${companyCode}`) || '{}');
        }

        function saveClientToDatabase(clientName, priceSen, priceAdasa, openingBalance = 0) {
            const session = sessionStorage.getItem('currentUser');
            const user = session ? JSON.parse(session) : null;
            const companyCode = user?.companyCode || 'default';
            
            const clients = getClientsDatabase();
            clients[clientName] = {
                name: clientName,
                priceSen: parseFloat(priceSen) || 0,
                priceAdasa: parseFloat(priceAdasa) || 0,
                openingBalance: parseFloat(openingBalance) || 0,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem(`clientsDatabase_${companyCode}`, JSON.stringify(clients));
        }
        
        function getClientPayments(clientName) {
            // حساب المدفوعات من الخزينة
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            const treasuryPayments = transactions
                .filter(t => t.type === 'income' && t.description.includes(clientName))
                .reduce((sum, t) => sum + t.amount, 0);
            
            // حساب المدفوعات من معاملات العميل
            const clientTransactions = getClientTransactions(clientName);
            const clientPayments = clientTransactions
                .filter(t => t.type === 'payment')
                .reduce((sum, t) => sum + t.amount, 0);
            
            return treasuryPayments + clientPayments;
        }
        
        function addClientPayment(clientName, amount, description) {
            // حفظ في الخزينة
            const transaction = {
                id: Date.now(),
                type: 'income',
                description: `تحصيل من ${clientName} - ${description}`,
                amount: parseFloat(amount),
                date: new Date().toISOString(),
                balance: calculateNewBalance('income', parseFloat(amount))
            };
            
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            // حفظ في معاملات العميل
            const clientTransactions = JSON.parse(localStorage.getItem('clientTransactions') || '{}');
            if (!clientTransactions[clientName]) {
                clientTransactions[clientName] = [];
            }
            
            clientTransactions[clientName].push({
                id: Date.now() + 1,
                type: 'payment',
                amount: parseFloat(amount),
                description: description,
                date: new Date().toISOString()
            });
            
            localStorage.setItem('clientTransactions', JSON.stringify(clientTransactions));
            
            return transaction;
        }
        
        function addPayment(clientName) {
            const amount = prompt(`كم المبلغ المحصل من ${clientName}؟`);
            const description = prompt('وصف الدفعة (اختياري):') || 'دفعة على الحساب';
            
            if (amount && !isNaN(parseFloat(amount))) {
                addClientPayment(clientName, parseFloat(amount), description);
                loadClients();
                showNotification(`تم تسجيل دفعة ${amount} ج.م من ${clientName}`);
            }
        }
        
        function addSaleToClientBalance(clientName, amount, permissionNumber) {
            // حفظ المبيعة في سجل معاملات العميل
            const clientTransactions = JSON.parse(localStorage.getItem('clientTransactions') || '{}');
            
            if (!clientTransactions[clientName]) {
                clientTransactions[clientName] = [];
            }
            
            clientTransactions[clientName].push({
                id: Date.now(),
                type: 'sale',
                amount: amount,
                description: `مبيعة - إذن رقم ${permissionNumber}`,
                date: new Date().toISOString()
            });
            
            localStorage.setItem('clientTransactions', JSON.stringify(clientTransactions));
        }
        
        function getClientTransactions(clientName) {
            const clientTransactions = JSON.parse(localStorage.getItem('clientTransactions') || '{}');
            return clientTransactions[clientName] || [];
        }
        
        function getClientTotalSales(clientName) {
            const transactions = getClientTransactions(clientName);
            return transactions
                .filter(t => t.type === 'sale')
                .reduce((sum, t) => sum + t.amount, 0);
        }

        let currentStatementClient = '';
        let statementData = [];
        
        function loadStatementData(clientName) {
            const client = getClientsDatabase()[clientName];
            if (!client) return;
            
            const startDate = new Date(document.getElementById('statementStartDate').value);
            const endDate = new Date(document.getElementById('statementEndDate').value);
            endDate.setHours(23, 59, 59, 999);
            
            // جلب جميع الأذون للعميل
            const allPermissions = JSON.parse(localStorage.getItem('permissions') || '[]')
                .filter(p => p.clientName === clientName);
            
            // جلب جميع المدفوعات للعميل
            const allPayments = getClientTransactions(clientName)
                .filter(t => t.type === 'payment');
            
            // فلترة البيانات للفترة المحددة للعرض
            const permissions = allPermissions.filter(p => {
                const date = new Date(p.date);
                return date >= startDate && date <= endDate;
            });
            
            const payments = allPayments.filter(t => {
                const date = new Date(t.date);
                return date >= startDate && date <= endDate;
            });
            
            statementData = [];
            
            // إضافة المبيعات
            permissions.forEach(p => {
                statementData.push({
                    type: 'sale',
                    date: p.date,
                    permissionNumber: p.permissionNumber,
                    carNumber: p.carNumber,
                    trailerNumber: p.trailerNumber || '-',
                    volume: p.volume,
                    pricePerMeter: p.pricePerMeter,
                    amount: parseFloat(p.totalPrice),
                    description: `مبيعة - إذن رقم ${p.permissionNumber}`,
                    id: p.id
                });
            });
            
            // إضافة المدفوعات
            payments.forEach(p => {
                statementData.push({
                    type: 'payment',
                    date: p.date,
                    permissionNumber: '-',
                    carNumber: '-',
                    trailerNumber: '-',
                    volume: '-',
                    pricePerMeter: '-',
                    amount: parseFloat(p.amount),
                    description: p.description,
                    id: p.id
                });
            });
            
            // ترتيب حسب التاريخ
            statementData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // حساب الرصيد الجاري
            let runningBalance = parseFloat(client.openingBalance || 0);
            statementData.forEach(item => {
                if (item.type === 'sale') {
                    runningBalance += item.amount;
                } else {
                    runningBalance -= item.amount;
                }
                item.runningBalance = runningBalance;
            });
            
            // حساب الملخص
            const openingBalance = parseFloat(client.openingBalance || 0);
            const totalSalesInPeriod = permissions.reduce((sum, p) => sum + parseFloat(p.totalPrice), 0);
            const totalPaymentsInPeriod = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // الرصيد الحالي = رصيد البداية + جميع المبيعات - جميع المدفوعات
            const allSalesTotal = allPermissions.reduce((sum, p) => sum + parseFloat(p.totalPrice), 0);
            const allPaymentsTotal = allPayments.reduce((sum, p) => sum + p.amount, 0);
            const currentBalance = openingBalance + allSalesTotal - allPaymentsTotal;
            
            // تحديث الملخص
            document.getElementById('openingBalance').textContent = `${openingBalance.toFixed(2)} ج.م`;
            document.getElementById('totalSalesAmount').textContent = `${totalSalesInPeriod.toFixed(2)} ج.م`;
            document.getElementById('totalPaymentsAmount').textContent = `${totalPaymentsInPeriod.toFixed(2)} ج.م`;
            document.getElementById('currentBalanceAmount').textContent = `${currentBalance.toFixed(2)} ج.م`;
            
            // تحديث الجدول
            renderStatementTable();
        }
        
        function renderStatementTable() {
            const tbody = document.getElementById('statementTableBody');
            
            if (statementData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data-2026"><i class="fas fa-inbox"></i><br>لا توجد بيانات للفترة المحددة</td></tr>';
                return;
            }
            
            tbody.innerHTML = statementData.map((item, index) => {
                const date = new Date(item.date).toLocaleDateString('ar-EG');
                const rowClass = item.type === 'payment' ? 'transaction-row payment' : 'transaction-row sale';
                
                return `
                <tr class="${rowClass}">
                    <td><span class="serial-number">${index + 1}</span></td>
                    <td><span class="date-display">${date}</span></td>
                    <td>
                        <span class="transaction-type-badge ${item.type}">
                            ${item.type === 'sale' ? 'مبيعة' : 'دفعة'}
                        </span>
                    </td>
                    <td><span class="permission-number">${item.permissionNumber}</span></td>
                    <td><span class="car-number">${item.carNumber}</span></td>
                    <td><span class="volume-display">${item.volume !== '-' ? item.volume + ' م³' : '-'}</span></td>
                    <td><span class="price-display">${item.pricePerMeter !== '-' ? item.pricePerMeter + ' ج.م' : '-'}</span></td>
                    <td>
                        <span class="amount-display ${item.type === 'sale' ? 'positive' : 'negative'}">
                            ${item.type === 'sale' ? '+' : '-'}${item.amount.toFixed(2)} ج.م
                        </span>
                    </td>
                    <td><span class="balance-display">${item.runningBalance.toFixed(2)} ج.م</span></td>
                    <td>
                        <div class="action-buttons-2026">
                            ${item.type === 'sale' ? `
                                <button class="action-btn-small edit" onclick="editStatementItem('${item.type}', ${item.id})" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            <button class="action-btn-small delete" onclick="deleteStatementItem('${item.type}', ${item.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        function filterStatement() {
            loadStatementData(currentStatementClient);
            showNotification('تم تحديث الكشف بنجاح!');
        }

        function viewClientStatement(clientName) {
            currentStatementClient = clientName;
            
            // تحديث عنوان النافذة وصورة العميل
            document.getElementById('statementClientName').textContent = clientName;
            const avatar = document.getElementById('statementClientAvatar');
            if (avatar) {
                avatar.textContent = clientName.charAt(0).toUpperCase();
            }
            
            // تعيين التواريخ الافتراضية (آخر 3 شهور)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 3);
            
            document.getElementById('statementStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('statementEndDate').value = endDate.toISOString().split('T')[0];
            
            // تحديث فترة العرض
            const periodElement = document.getElementById('statementPeriod');
            if (periodElement) {
                periodElement.textContent = `(${startDate.toLocaleDateString('ar-EG')} - ${endDate.toLocaleDateString('ar-EG')})`;
            }
            
            // تحميل بيانات كشف الحساب
            loadStatementData(clientName);
            
            // فتح النافذة المنبثقة
            const modal = document.getElementById('clientStatementModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            showNotification(`تم فتح كشف حساب ${clientName}`);
        }

        function loadPageClientStatement() {
            const clientName = currentStatementClient;
            const client = getClientsDatabase()[clientName];
            if (!client) return;
            
            const startDate = new Date(document.getElementById('statementStartDate').value);
            const endDate = new Date(document.getElementById('statementEndDate').value);
            endDate.setHours(23, 59, 59, 999);
            
            // جلب جميع الأذون للعميل (ليس فقط في الفترة المحددة)
            const allPermissions = JSON.parse(localStorage.getItem('permissions') || '[]')
                .filter(p => p.clientName === clientName);
            
            // جلب جميع المدفوعات للعميل (ليس فقط في الفترة المحددة)
            const allPayments = getClientTransactions(clientName)
                .filter(t => t.type === 'payment');
            
            // فلترة البيانات للفترة المحددة للعرض فقط
            const permissions = allPermissions.filter(p => {
                const date = new Date(p.date);
                return date >= startDate && date <= endDate;
            });
            
            const payments = allPayments.filter(t => {
                const date = new Date(t.date);
                return date >= startDate && date <= endDate;
            });
            
            statementData = [];
            
            // إضافة المبيعات
            permissions.forEach(p => {
                statementData.push({
                    type: 'sale',
                    date: p.date,
                    permissionNumber: p.permissionNumber,
                    carNumber: p.carNumber,
                    trailerNumber: p.trailerNumber || '-',
                    volume: p.volume,
                    pricePerMeter: p.pricePerMeter,
                    amount: parseFloat(p.totalPrice),
                    description: `مبيعة - إذن رقم ${p.permissionNumber}`,
                    id: p.id
                });
            });
            
            // إضافة المدفوعات
            payments.forEach(p => {
                statementData.push({
                    type: 'payment',
                    date: p.date,
                    permissionNumber: '-',
                    carNumber: '-',
                    trailerNumber: '-',
                    volume: '-',
                    pricePerMeter: '-',
                    amount: parseFloat(p.amount),
                    description: p.description,
                    id: p.id
                });
            });
            
            // ترتيب حسب التاريخ
            statementData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // حساب الرصيد الجاري
            let runningBalance = parseFloat(client.openingBalance || 0);
            statementData.forEach(item => {
                if (item.type === 'sale') {
                    runningBalance += item.amount;
                } else {
                    runningBalance -= item.amount;
                }
                item.runningBalance = runningBalance;
            });
            
            // حساب الملخص الصحيح
            const openingBalance = parseFloat(client.openingBalance || 0);
            const totalSalesInPeriod = permissions.reduce((sum, p) => sum + parseFloat(p.totalPrice), 0);
            const totalPaymentsInPeriod = payments.reduce((sum, p) => sum + p.amount, 0);
            
            // الرصيد الحالي = رصيد البداية + جميع المبيعات - جميع المدفوعات
            const allSalesTotal = allPermissions.reduce((sum, p) => sum + parseFloat(p.totalPrice), 0);
            const allPaymentsTotal = allPayments.reduce((sum, p) => sum + p.amount, 0);
            const currentBalance = openingBalance + allSalesTotal - allPaymentsTotal;
            
            updatePageStatementSummary({
                openingBalance,
                totalSalesInPeriod,
                totalPaymentsInPeriod,
                currentBalance
            });
            renderPageStatementTable();
        }

        function updatePageStatementSummary(data) {
            document.getElementById('pageOpeningBalance').textContent = `${data.openingBalance.toFixed(2)} ج.م`;
            document.getElementById('pageTotalSales').textContent = `${data.totalSalesInPeriod.toFixed(2)} ج.م`;
            document.getElementById('pageTotalPayments').textContent = `${data.totalPaymentsInPeriod.toFixed(2)} ج.م`;
            document.getElementById('pageCurrentBalance').textContent = `${data.currentBalance.toFixed(2)} ج.م`;
        }

        function renderPageStatementTable() {
            const tbody = document.getElementById('pageStatementTableBody');
            
            if (statementData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">لا توجد بيانات للفترة المحددة</td></tr>';
                return;
            }
            
            tbody.innerHTML = statementData.map((item, index) => {
                const date = new Date(item.date).toLocaleDateString('ar-EG');
                const rowClass = item.type === 'payment' ? 'payment-row' : 'sale-row';
                
                return `
                <tr class="${rowClass}">
                    <td>${index + 1}</td>
                    <td>${date}</td>
                    <td>${item.permissionNumber}</td>
                    <td>${item.carNumber}</td>
                    <td>${item.trailerNumber}</td>
                    <td>${item.volume !== '-' ? item.volume + ' م³' : '-'}</td>
                    <td>${item.pricePerMeter !== '-' ? item.pricePerMeter + ' ج.م' : '-'}</td>
                    <td class="amount-cell ${item.type}">
                        ${item.type === 'sale' ? '+' : '-'}${item.amount.toFixed(2)} ج.م
                    </td>
                    <td class="balance-cell">${item.runningBalance.toFixed(2)} ج.م</td>
                    <td>
                        <div class="action-buttons">
                            ${item.type === 'sale' ? `
                                <button class="action-btn edit" onclick="editStatementItem('${item.type}', ${item.id})" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            <button class="action-btn delete" onclick="deleteStatementItem('${item.type}', ${item.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function closeStatementModal() {
            const modal = document.getElementById('clientStatementModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            
            // تنظيف البيانات
            currentStatementClient = '';
            statementData = [];
            
            // إعادة تعيين القيم الافتراضية
            document.getElementById('statementClientName').textContent = 'اسم العميل';
            document.getElementById('statementClientAvatar').textContent = 'A';
            document.getElementById('openingBalance').textContent = '0 ج.م';
            document.getElementById('totalSalesAmount').textContent = '0 ج.م';
            document.getElementById('totalPaymentsAmount').textContent = '0 ج.م';
            document.getElementById('currentBalanceAmount').textContent = '0 ج.م';
        }

        function filterPageStatement() {
            loadPageClientStatement();
            showNotification('تم تحديث الكشف بنجاح!');
        }
        
        function backToClients() {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector('[data-section="clients"]').classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById('clients-section').classList.add('active');
            document.getElementById('pageTitle').textContent = 'Clients';
            
            loadClients();
        }
        
        function addPagePayment() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('show');
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
        }
        
        function printPageStatement() {
            window.print();
        }

        function addPaymentToStatement() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('show');
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.remove('show');
            document.getElementById('paymentForm').reset();
        }

        function editStatementItem(type, id) {
            if (type === 'sale') {
                editPermission(id);
            }
        }

        function deleteStatementItem(type, id) {
            if (confirm('هل أنت متأكد من حذف هذه المعاملة؟')) {
                if (type === 'sale') {
                    deletePermission(id);
                } else if (type === 'payment') {
                    deleteClientPayment(id);
                }
                loadPageClientStatement();
                loadClients();
            }
        }

        function deleteClientPayment(paymentId) {
            const clientTransactions = JSON.parse(localStorage.getItem('clientTransactions') || '{}');
            if (clientTransactions[currentStatementClient]) {
                clientTransactions[currentStatementClient] = clientTransactions[currentStatementClient]
                    .filter(t => t.id !== paymentId);
                localStorage.setItem('clientTransactions', JSON.stringify(clientTransactions));
            }
        }

        function printStatement() {
            if (!currentStatementClient) {
                showNotification('لم يتم تحديد عميل للطباعة', 'error');
                return;
            }
            
            const client = getClientsDatabase()[currentStatementClient];
            if (!client) {
                showNotification('بيانات العميل غير موجودة', 'error');
                return;
            }
            
            try {
                const allPermissions = JSON.parse(localStorage.getItem('permissions') || '[]')
                    .filter(p => p.clientName === currentStatementClient);
                const allPayments = getClientTransactions(currentStatementClient)
                    .filter(t => t.type === 'payment');
                
                const openingBalance = parseFloat(client.openingBalance || 0);
                const totalSales = allPermissions.reduce((sum, p) => sum + parseFloat(p.totalPrice), 0);
                const totalPayments = allPayments.reduce((sum, p) => sum + p.amount, 0);
                const currentBalance = openingBalance + totalSales - totalPayments;
                
                // فتح نافذة طباعة جديدة
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    showNotification('فشل في فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.', 'error');
                    return;
                }
                
                printWindow.document.write(`
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>كشف حساب ${currentStatementClient}</title>
                        <style>
                            body { font-family: 'Cairo', Arial, sans-serif; margin: 20px; color: #333; }
                            .header { display: flex; justify-content: space-between; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                            .company-info h1 { color: #333; font-size: 28px; margin: 0; }
                            .company-info p { color: #666; margin: 5px 0; }
                            .statement-info { text-align: left; }
                            .statement-info h2 { color: #333; font-size: 24px; margin: 0 0 15px 0; }
                            .balance-summary { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
                            .balance-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6; }
                            .balance-row:last-child { border-bottom: none; }
                            .balance-row.final { border-top: 2px solid #333; margin-top: 15px; padding-top: 15px; font-weight: bold; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #333; padding: 8px; text-align: center; }
                            th { background: #f5f5f5; font-weight: bold; }
                            .payment-row { background: #fff3cd; }
                            .sale-row { background: #d1ecf1; }
                            .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; color: #666; font-size: 14px; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="company-info">
                                <h1>شركة البصيرة للمقاولات</h1>
                                <p>متخصصون في توريد مواد البناء</p>
                                <p>📞 هاتف: 01234567890</p>
                                <p>📱 واتس: 01234567890</p>
                                <p>👨💼 محاسب: أحمد محمد - 01111111111</p>
                            </div>
                            <div class="statement-info">
                                <h2>كشف حساب عميل</h2>
                                <p><strong>اسم العميل:</strong> ${currentStatementClient}</p>
                                <p><strong>تاريخ الطباعة:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
                            </div>
                        </div>
                        
                        <div class="balance-summary">
                            <div class="balance-row">
                                <span>رصيد بداية الفترة:</span>
                                <span>${openingBalance.toFixed(2)} ج.م</span>
                            </div>
                            <div class="balance-row">
                                <span>إجمالي المبيعات:</span>
                                <span>${totalSales.toFixed(2)} ج.م</span>
                            </div>
                            <div class="balance-row">
                                <span>إجمالي المدفوعات:</span>
                                <span>${totalPayments.toFixed(2)} ج.م</span>
                            </div>
                            <div class="balance-row final">
                                <span>الرصيد النهائي:</span>
                                <span>${currentBalance.toFixed(2)} ج.م</span>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>م</th>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>الوصف</th>
                                    <th>المبلغ</th>
                                    <th>الرصيد</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${statementData.length === 0 ? '<tr><td colspan="6">لا توجد معاملات للفترة المحددة</td></tr>' : 
                                    statementData.map((item, index) => {
                                        const date = new Date(item.date).toLocaleDateString('ar-EG');
                                        const rowClass = item.type === 'payment' ? 'payment-row' : 'sale-row';
                                        
                                        return `
                                            <tr class="${rowClass}">
                                                <td>${index + 1}</td>
                                                <td>${date}</td>
                                                <td>${item.type === 'sale' ? 'مبيعة' : 'دفعة'}</td>
                                                <td>${item.description}</td>
                                                <td>${item.type === 'sale' ? '+' : '-'}${item.amount.toFixed(2)} ج.م</td>
                                                <td>${item.runningBalance.toFixed(2)} ج.م</td>
                                            </tr>
                                        `;
                                    }).join('')
                                }
                            </tbody>
                        </table>
                        
                        <div class="footer">
                            <p>تم إعداد هذا الكشف بواسطة نظام إدارة المبيعات - شركة البصيرة</p>
                            <p>للمراجعة والاستفسار يرجى التواصل مع قسم المحاسبة</p>
                        </div>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.close();
                
                showNotification('تم إرسال كشف الحساب للطباعة', 'success');
                
            } catch (error) {
                console.error('Error printing statement:', error);
                showNotification('حدث خطأ أثناء الطباعة', 'error');
            }
        }

        document.getElementById('paymentForm').onsubmit = function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const description = document.getElementById('paymentDescription').value;
            const date = document.getElementById('paymentDate').value;
            const notes = document.getElementById('paymentNotes').value;
            
            if (!amount || !description) {
                alert('الرجاء ملء جميع الحقول المطلوبة');
                return;
            }
            
            const clientTransactions = JSON.parse(localStorage.getItem('clientTransactions') || '{}');
            if (!clientTransactions[currentStatementClient]) {
                clientTransactions[currentStatementClient] = [];
            }
            
            clientTransactions[currentStatementClient].push({
                id: Date.now(),
                type: 'payment',
                amount: amount,
                description: description,
                date: new Date(date).toISOString(),
                notes: notes
            });
            
            localStorage.setItem('clientTransactions', JSON.stringify(clientTransactions));
            
            addClientPayment(currentStatementClient, amount, description);
            
            closePaymentModal();
            loadPageClientStatement();
            loadClients();
            showNotification('تم إضافة الدفعة بنجاح!');
        };
        
        function showClientStatement(clientName) {
            const client = getClientsDatabase()[clientName];
            if (!client) return;
            
            const transactions = getClientTransactions(clientName);
            const openingBalance = parseFloat(client.openingBalance || 0);
            let runningBalance = openingBalance;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';
            
            modal.innerHTML = `
                <div class="statement-modal">
                    <div class="statement-header">
                        <h2>كشف حساب ${clientName}</h2>
                        <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="statement-summary">
                        <div class="summary-item">
                            <span class="label">رصيد بداية الفترة:</span>
                            <span class="value ${openingBalance >= 0 ? 'positive' : 'negative'}">
                                ${Math.abs(openingBalance).toFixed(2)} ج.م
                                <small>${openingBalance >= 0 ? 'له عندنا' : 'عليه'}</small>
                            </span>
                        </div>
                        <div class="summary-item">
                            <span class="label">الرصيد الحالي:</span>
                            <span class="value ${runningBalance >= 0 ? 'positive' : 'negative'}">
                                ${Math.abs(runningBalance).toFixed(2)} ج.م
                                <small>${runningBalance >= 0 ? 'له عندنا' : 'عليه'}</small>
                            </span>
                        </div>
                    </div>
                    
                    <div class="statement-transactions">
                        <h3>المعاملات</h3>
                        <div class="transactions-list">
                            ${transactions.length === 0 ? '<div class="no-transactions">لا توجد معاملات</div>' : 
                                transactions.map(t => {
                                    const date = new Date(t.date).toLocaleDateString('ar-EG');
                                    const time = new Date(t.date).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
                                    
                                    if (t.type === 'sale') {
                                        runningBalance = openingBalance + transactions.slice(0, transactions.indexOf(t) + 1)
                                            .reduce((sum, tr) => sum + (tr.type === 'sale' ? tr.amount : -tr.amount), 0);
                                    } else {
                                        runningBalance = openingBalance + transactions.slice(0, transactions.indexOf(t) + 1)
                                            .reduce((sum, tr) => sum + (tr.type === 'sale' ? tr.amount : -tr.amount), 0);
                                    }
                                    
                                    return `
                                        <div class="transaction-item ${t.type}">
                                            <div class="transaction-date">
                                                <span class="date">${date}</span>
                                                <span class="time">${time}</span>
                                            </div>
                                            <div class="transaction-details">
                                                <span class="type">${t.type === 'sale' ? 'مبيعة' : 'دفعة'}</span>
                                                <span class="description">${t.description}</span>
                                            </div>
                                            <div class="transaction-amount ${t.type}">
                                                ${t.type === 'sale' ? '+' : '-'}${t.amount.toFixed(2)} ج.م
                                            </div>
                                            <div class="running-balance">
                                                ${Math.abs(runningBalance).toFixed(2)} ج.م
                                            </div>
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    </div>
                    
                    <div class="statement-actions">
                        <button class="modern-btn secondary" onclick="this.closest('.modal-overlay').remove()">إغلاق</button>
                        <button class="modern-btn primary" onclick="printStatement('${clientName}')">طباعة</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // Close on outside click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                    document.body.style.overflow = 'auto';
                }
            };
        }
        
        function printStatement(clientName) {
            const client = getClientsDatabase()[clientName];
            if (!client) return;
            
            const transactions = getClientTransactions(clientName);
            const openingBalance = parseFloat(client.openingBalance || 0);
            const totalSales = transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
            const totalPayments = transactions.filter(t => t.type === 'payment').reduce((sum, t) => sum + t.amount, 0);
            const currentBalance = openingBalance + totalSales - totalPayments;
            
            // Create print content
            const printContent = `
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف حساب ${clientName}</title>
                    <style>
                        body { font-family: 'Cairo', Arial, sans-serif; margin: 20px; color: #333; }
                        .header { display: flex; justify-content: space-between; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .company-info h1 { color: #333; font-size: 28px; margin: 0; }
                        .company-info p { color: #666; margin: 5px 0; }
                        .statement-info { text-align: left; }
                        .statement-info h2 { color: #333; font-size: 24px; margin: 0 0 15px 0; }
                        .balance-summary { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
                        .balance-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #dee2e6; }
                        .balance-row:last-child { border-bottom: none; }
                        .balance-row.final { border-top: 2px solid #333; margin-top: 15px; padding-top: 15px; font-weight: bold; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
                        th { background: #f5f5f5; font-weight: bold; }
                        .payment-row { background: #fff3cd; }
                        .sale-row { background: #d1ecf1; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; color: #666; font-size: 14px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="company-info">
                            <h1>شركة البصيرة للمقاولات</h1>
                            <p>متخصصون في توريد مواد البناء</p>
                            <p>📞 هاتف: 01234567890</p>
                            <p>📱 واتس: 01234567890</p>
                            <p>👨‍💼 محاسب: أحمد محمد - 01111111111</p>
                        </div>
                        <div class="statement-info">
                            <h2>كشف حساب عميل</h2>
                            <p><strong>اسم العميل:</strong> ${clientName}</p>
                            <p><strong>تاريخ الطباعة:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
                        </div>
                    </div>
                    
                    <div class="balance-summary">
                        <div class="balance-row">
                            <span>رصيد بداية الفترة:</span>
                            <span>${openingBalance.toFixed(2)} ج.م</span>
                        </div>
                        <div class="balance-row">
                            <span>إجمالي المبيعات:</span>
                            <span>${totalSales.toFixed(2)} ج.م</span>
                        </div>
                        <div class="balance-row">
                            <span>إجمالي المدفوعات:</span>
                            <span>${totalPayments.toFixed(2)} ج.م</span>
                        </div>
                        <div class="balance-row final">
                            <span>الرصيد النهائي:</span>
                            <span>${currentBalance.toFixed(2)} ج.م</span>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>م</th>
                                <th>التاريخ</th>
                                <th>النوع</th>
                                <th>الوصف</th>
                                <th>المبلغ</th>
                                <th>الرصيد</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transactions.length === 0 ? '<tr><td colspan="6">لا توجد معاملات</td></tr>' : 
                                transactions.map((t, index) => {
                                    let runningBalance = openingBalance;
                                    for (let i = 0; i <= index; i++) {
                                        if (transactions[i].type === 'sale') {
                                            runningBalance += transactions[i].amount;
                                        } else {
                                            runningBalance -= transactions[i].amount;
                                        }
                                    }
                                    
                                    const date = new Date(t.date).toLocaleDateString('ar-EG');
                                    const rowClass = t.type === 'payment' ? 'payment-row' : 'sale-row';
                                    
                                    return `
                                        <tr class="${rowClass}">
                                            <td>${index + 1}</td>
                                            <td>${date}</td>
                                            <td>${t.type === 'sale' ? 'مبيعة' : 'دفعة'}</td>
                                            <td>${t.description}</td>
                                            <td>${t.type === 'sale' ? '+' : '-'}${t.amount.toFixed(2)} ج.م</td>
                                            <td>${runningBalance.toFixed(2)} ج.م</td>
                                        </tr>
                                    `;
                                }).join('')
                            }
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>تم إعداد هذا الكشف بواسطة نظام إدارة المبيعات - شركة البصيرة</p>
                        <p>للمراجعة والاستفسار يرجى التواصل مع قسم المحاسبة</p>
                    </div>
                </body>
                </html>
            `;
            
            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }
        
        // تم نقل هذه الدالة إلى الأعلى

        function getClientPricing(clientName) {
            const clients = getClientsDatabase();
            return clients[clientName] || { priceSen: 0, priceAdasa: 0 };
        }

        // Update price based on client selection
        function updatePriceByClient() {
            const clientNameInput = safeGetElement('clientName');
            const priceInput = safeGetElement('pricePerMeter');
            const materialTypeInput = safeGetElement('materialType');
            
            if (!clientNameInput || !priceInput) return;
            
            const clientName = clientNameInput.value;
            if (!clientName) {
                priceInput.value = '';
                return;
            }
            
            try {
                const clientPricing = getClientPricing(clientName);
                const materialType = materialTypeInput ? materialTypeInput.value : 'سن';
                
                // تحديد السعر حسب نوع المادة
                if (materialType === 'عدسة') {
                    priceInput.value = clientPricing.priceAdasa || '';
                } else {
                    // استخدام سعر السن كافتراضي
                    priceInput.value = clientPricing.priceSen || '';
                }
                
                calculateTotal();
                
                // إشعار المستخدم بتحديث السعر
                if (priceInput.value) {
                    showNotification(`تم تحديث السعر تلقائياً: ${priceInput.value} ج.م`, 'success');
                }
            } catch (error) {
                console.error('Error updating price by client:', error);
                showNotification('خطأ في تحديث السعر', 'error');
            }
        }

        // Update client selection to trigger price update
        function selectClient(clientName) {
            const clientNameInput = safeGetElement('clientName');
            const clientDropdown = safeGetElement('clientDropdown');
            
            if (clientNameInput) {
                clientNameInput.value = sanitizeInput(clientName);
            }
            if (clientDropdown) {
                clientDropdown.style.display = 'none';
            }
            
            // تحديث السعر بعد اختيار العميل
            setTimeout(() => {
                updatePriceByClient();
            }, 100);
        }
        
        // تحسين وظيفة فتح نافذة إضافة عميل
        function openClientModal() {
            const modal = safeGetElement('clientModal');
            const modalTitle = safeGetElement('clientModalTitle');
            
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
            
            if (modalTitle) {
                modalTitle.textContent = 'إضافة عميل جديد';
            }
            
            // تنظيف النموذج
            const form = safeGetElement('clientForm');
            if (form) {
                form.reset();
                form.removeAttribute('data-edit-client');
            }
        }

        // Bank & Check Management Functions

        function loadBankManagement() {
            loadChecks();
            checkDueNotifications();
        }

        function loadChecks() {
            const checks = JSON.parse(localStorage.getItem('checks') || '[]');
            allChecks = checks.map(check => ({
                ...check,
                status: getCheckStatus(check.dueDate)
            }));
            
            renderChecksTable(allChecks);
            updateFinancialDashboard();
        }

        function getCheckStatus(dueDate) {
            const today = new Date();
            const due = new Date(dueDate);
            today.setHours(0, 0, 0, 0);
            due.setHours(0, 0, 0, 0);
            
            if (due.getTime() === today.getTime()) return 'due-today';
            if (due < today) return 'overdue';
            return 'pending';
        }

        function renderChecksTable(checks) {
            const tbody = document.getElementById('checksTable');
            
            if (checks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">لا توجد شيكات</td></tr>';
                return;
            }
            
            tbody.innerHTML = checks.map(check => {
                const statusText = {
                    'pending': 'مستحق لاحقاً',
                    'due-today': 'مستحق اليوم',
                    'overdue': 'متأخر',
                    'cleared': 'تم الصرف'
                };
                
                const rowClass = check.status === 'due-today' ? 'due-today-row' : '';
                
                return `
                <tr class="${rowClass}">
                    <td><span class="check-number">${check.checkNumber}</span></td>
                    <td><span class="bank-name">${check.bankName}</span></td>
                    <td><span class="client-name">${check.clientName}</span></td>
                    <td><span class="due-date">${new Date(check.dueDate).toLocaleDateString('ar-EG')}</span></td>
                    <td><span class="check-amount">${parseFloat(check.amount).toFixed(2)} ج.م</span></td>
                    <td><span class="check-status ${check.status}">${statusText[check.status]}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${check.status !== 'cleared' ? `
                                <button class="action-btn edit" onclick="editCheck(${check.id})" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn clear" onclick="clearCheck(${check.id})" title="تم الصرف">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                            <button class="action-btn delete" onclick="deleteCheck(${check.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function updateFinancialDashboard() {
            const totalValue = allChecks.reduce((sum, c) => sum + parseFloat(c.amount), 0);
            const dueTodayValue = allChecks.filter(c => c.status === 'due-today').reduce((sum, c) => sum + parseFloat(c.amount), 0);
            const clearedValue = allChecks.filter(c => c.status === 'cleared').reduce((sum, c) => sum + parseFloat(c.amount), 0);
            
            const today = new Date();
            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const dueWeekValue = allChecks.filter(c => {
                const dueDate = new Date(c.dueDate);
                return dueDate >= today && dueDate <= weekFromNow && c.status !== 'cleared';
            }).reduce((sum, c) => sum + parseFloat(c.amount), 0);
            
            document.getElementById('totalChecksValue').textContent = `${totalValue.toFixed(2)} ج.م`;
            document.getElementById('dueTodayValue').textContent = `${dueTodayValue.toFixed(2)} ج.م`;
            document.getElementById('dueWeekValue').textContent = `${dueWeekValue.toFixed(2)} ج.م`;
            document.getElementById('clearedValue').textContent = `${clearedValue.toFixed(2)} ج.م`;
        }

        function checkDueNotifications() {
            const dueToday = allChecks.filter(c => c.status === 'due-today');
            
            dueToday.forEach(check => {
                showDueCheckNotification(check);
            });
        }

        function showDueCheckNotification(check) {
            const toast = document.createElement('div');
            toast.className = 'due-check-toast';
            toast.innerHTML = `
                <div class="toast-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>شيك مستحق اليوم!</strong>
                </div>
                <div class="toast-body">
                    <p>شيك رقم: ${check.checkNumber}</p>
                    <p>العميل: ${check.clientName}</p>
                    <p>المبلغ: ${parseFloat(check.amount).toFixed(2)} ج.م</p>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 10000);
        }

        function openCheckModal() {
            const modal = document.getElementById('checkModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            document.getElementById('checkModalTitle').textContent = 'إضافة شيك جديد';
        }

        function closeCheckModal() {
            const modal = document.getElementById('checkModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            document.getElementById('checkForm').reset();
            document.getElementById('checkForm').removeAttribute('data-edit-id');
        }

        function editCheck(id) {
            const check = allChecks.find(c => c.id === id);
            if (check) {
                document.getElementById('checkNumber').value = check.checkNumber;
                document.getElementById('bankName').value = check.bankName;
                document.getElementById('checkClientName').value = check.clientName;
                document.getElementById('dueDate').value = check.dueDate;
                document.getElementById('checkAmount').value = check.amount;
                document.getElementById('checkNotes').value = check.notes || '';
                
                document.getElementById('checkForm').setAttribute('data-edit-id', id);
                document.getElementById('checkModalTitle').textContent = 'تعديل بيانات الشيك';
                
                openCheckModal();
            }
        }

        function clearCheck(id) {
            if (confirm('هل أنت متأكد من صرف هذا الشيك؟')) {
                let checks = JSON.parse(localStorage.getItem('checks') || '[]');
                const checkIndex = checks.findIndex(c => c.id === id);
                if (checkIndex !== -1) {
                    checks[checkIndex].status = 'cleared';
                    checks[checkIndex].clearedDate = new Date().toISOString();
                    localStorage.setItem('checks', JSON.stringify(checks));
                    loadChecks();
                    showNotification('تم صرف الشيك بنجاح!');
                }
            }
        }

        function deleteCheck(id) {
            if (confirm('هل أنت متأكد من حذف هذا الشيك؟')) {
                let checks = JSON.parse(localStorage.getItem('checks') || '[]');
                checks = checks.filter(c => c.id !== id);
                localStorage.setItem('checks', JSON.stringify(checks));
                loadChecks();
                showNotification('تم حذف الشيك بنجاح!');
            }
        }

        function filterChecks(status) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const filtered = status === 'all' ? allChecks : allChecks.filter(c => c.status === status);
            renderChecksTable(filtered);
        }

        function searchChecks() {
            const search = document.getElementById('checkSearch').value.toLowerCase();
            const filtered = allChecks.filter(c => 
                c.checkNumber.toLowerCase().includes(search) ||
                c.bankName.toLowerCase().includes(search) ||
                c.clientName.toLowerCase().includes(search)
            );
            renderChecksTable(filtered);
        }

        function exportChecks() {
            const data = JSON.stringify(allChecks, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `checks-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('تم تصدير بيانات الشيكات!');
        }

        // Check Client Search Functions
        function filterCheckClients() {
            const input = document.getElementById('checkClientName').value.toLowerCase();
            const dropdown = document.getElementById('checkClientDropdown');
            const clients = getUniqueClients();
            
            if (input.length === 0) {
                dropdown.innerHTML = '';
                dropdown.style.display = 'none';
                return;
            }
            
            const filtered = clients.filter(client => 
                client.toLowerCase().startsWith(input)
            );
            
            if (filtered.length > 0) {
                dropdown.innerHTML = filtered.map(client => 
                    `<div class="client-option" onclick="selectCheckClient('${client}')">${client}</div>`
                ).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function showCheckClientList() {
            const input = document.getElementById('checkClientName').value;
            if (input.length === 0) {
                const dropdown = document.getElementById('checkClientDropdown');
                const clients = getUniqueClients();
                
                if (clients.length > 0) {
                    dropdown.innerHTML = clients.map(client => 
                        `<div class="client-option" onclick="selectCheckClient('${client}')">${client}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                }
            }
        }

        function hideCheckClientList() {
            setTimeout(() => {
                document.getElementById('checkClientDropdown').style.display = 'none';
            }, 200);
        }

        function selectCheckClient(clientName) {
            document.getElementById('checkClientName').value = clientName;
            document.getElementById('checkClientDropdown').style.display = 'none';
        }

        // Check Form Submission
        const checkForm = document.getElementById('checkForm');
        if (checkForm) {
            checkForm.onsubmit = function(e) {
            e.preventDefault();
            
            const editId = this.getAttribute('data-edit-id');
            const check = {
                id: editId ? parseInt(editId) : Date.now(),
                checkNumber: document.getElementById('checkNumber').value,
                bankName: document.getElementById('bankName').value,
                clientName: document.getElementById('checkClientName').value,
                dueDate: document.getElementById('dueDate').value,
                amount: parseFloat(document.getElementById('checkAmount').value),
                notes: document.getElementById('checkNotes').value,
                status: 'pending',
                createdDate: editId ? null : new Date().toISOString()
            };
            
            let checks = JSON.parse(localStorage.getItem('checks') || '[]');
            
            if (editId) {
                const index = checks.findIndex(c => c.id === parseInt(editId));
                if (index !== -1) {
                    checks[index] = { ...checks[index], ...check };
                }
                showNotification('تم تعديل بيانات الشيك!');
            } else {
                checks.push(check);
                showNotification('تم إضافة الشيك بنجاح!');
            }
            
            localStorage.setItem('checks', JSON.stringify(checks));
            
            closeCheckModal();
            loadChecks();
            };
        }

        // Modal close handlers
        const checkModal = document.getElementById('checkModal');
        if (checkModal) {
            checkModal.onclick = function(e) {
                if (e.target === this) {
                    closeCheckModal();
                }
            };
        }

        // Initialize bank management on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for due notifications every time the page loads
            setTimeout(() => {
                if (JSON.parse(localStorage.getItem('checks') || '[]').length > 0) {
                    loadBankManagement();
                }
            }, 1000);
        });

        // Purchases Management Functions
        function loadPurchases() {
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            const {start, end} = getCurrentDayRange();
            allPurchases = purchases.filter(p => {
                const date = new Date(p.date);
                return date >= start && date < end;
            });
            
            renderPurchasesTable(allPurchases);
            updatePurchasesStats();
            loadSuppliers();
        }

        function renderPurchasesTable(purchases) {
            const tbody = document.getElementById('purchasesTable');
            tbody.innerHTML = purchases.map((purchase, i) => {
                const purchaseTime = new Date(purchase.date).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                return `
                <tr>
                    <td><span class="permission-badge">${purchase.purchaseNumber}</span></td>
                    <td>
                        <div class="client-info">
                            <div class="client-avatar">${purchase.supplierName.charAt(0).toUpperCase()}</div>
                            <span>${purchase.supplierName}</span>
                        </div>
                    </td>
                    <td><span class="material-type">${purchase.materialType}</span></td>
                    <td><span class="volume-display">${purchase.quantity}</span></td>
                    <td><span class="price-tag">${purchase.unitPrice} ج.م</span></td>
                    <td><span class="total-amount">${purchase.totalPrice} ج.م</span></td>
                    <td><span class="time-stamp">${purchaseTime}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editPurchase(${purchase.id})" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deletePurchase(${purchase.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function updatePurchasesStats() {
            const totalPurchases = allPurchases.reduce((sum, p) => sum + parseFloat(p.totalPrice), 0);
            const uniqueSuppliers = new Set(allPurchases.map(p => p.supplierName)).size;
            const totalOrders = allPurchases.length;
            
            document.getElementById('totalPurchasesToday').textContent = `${totalPurchases.toFixed(2)} ج.م`;
            document.getElementById('totalSuppliers').textContent = uniqueSuppliers;
            document.getElementById('totalPurchaseOrders').textContent = totalOrders;
        }

        function openPurchaseModal() {
            const modal = document.getElementById('purchaseModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closePurchaseModal() {
            const modal = document.getElementById('purchaseModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            document.getElementById('purchaseForm').reset();
            document.getElementById('purchaseTotal').textContent = '0.00 ج.م';
        }

        function calculatePurchaseTotal() {
            const quantity = parseFloat(document.getElementById('purchaseQuantity').value) || 0;
            const price = parseFloat(document.getElementById('purchaseUnitPrice').value) || 0;
            const total = (quantity * price).toFixed(2);
            document.getElementById('purchaseTotal').textContent = total + ' ج.م';
        }

        document.getElementById('purchaseForm').onsubmit = function(e) {
            e.preventDefault();
            
            const purchase = {
                id: Date.now(),
                supplierName: document.getElementById('supplierName').value,
                purchaseNumber: document.getElementById('purchaseNumber').value,
                materialType: document.getElementById('purchaseMaterialType').value,
                quantity: parseFloat(document.getElementById('purchaseQuantity').value),
                unitPrice: parseFloat(document.getElementById('purchaseUnitPrice').value),
                totalPrice: (parseFloat(document.getElementById('purchaseQuantity').value) * parseFloat(document.getElementById('purchaseUnitPrice').value)).toFixed(2),
                date: new Date().toISOString()
            };
            
            let purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            purchases.push(purchase);
            localStorage.setItem('purchases', JSON.stringify(purchases));
            
            closePurchaseModal();
            loadPurchases();
            showNotification('تم حفظ المشترى بنجاح!');
        };

        function filterPurchasesTable() {
            const search = document.getElementById('searchPurchases').value.toLowerCase();
            const filtered = allPurchases.filter(purchase => 
                purchase.supplierName.toLowerCase().includes(search) ||
                purchase.materialType.toLowerCase().includes(search)
            );
            renderPurchasesTable(filtered);
        }

        function exportPurchases() {
            const data = JSON.stringify(allPurchases, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `purchases-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('تم تصدير بيانات المشتريات!');
        }

        // Suppliers Management
        function loadSuppliers() {
            const suppliers = getSuppliersDatabase();
            allSuppliers = Object.values(suppliers);
            renderSuppliersGrid();
        }

        function getSuppliersDatabase() {
            return JSON.parse(localStorage.getItem('suppliersDatabase') || '{}');
        }

        function renderSuppliersGrid() {
            const grid = document.getElementById('suppliersGrid');
            
            if (allSuppliers.length === 0) {
                grid.innerHTML = '<div class="no-clients">لا توجد موردين مضافين</div>';
                return;
            }
            
            grid.innerHTML = allSuppliers.map(supplier => `
                <div class="client-card active">
                    <div class="client-header">
                        <div class="client-avatar">${supplier.name.charAt(0).toUpperCase()}</div>
                        <div class="client-info">
                            <h3>${supplier.name}</h3>
                            <p>${supplier.phone || 'لا يوجد رقم'}</p>
                        </div>
                    </div>
                    
                    <div class="client-actions">
                        <button class="action-btn edit" onclick="editSupplier('${supplier.name}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteSupplier('${supplier.name}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    ${supplier.notes ? `<div class="client-notes">${supplier.notes}</div>` : ''}
                </div>
            `).join('');
        }

        function openSupplierModal() {
            const modal = document.getElementById('supplierModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeSupplierModal() {
            const modal = document.getElementById('supplierModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
            document.getElementById('supplierForm').reset();
        }

        document.getElementById('supplierForm').onsubmit = function(e) {
            e.preventDefault();
            
            const supplierName = document.getElementById('supplierNameInput').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const address = document.getElementById('supplierAddress').value.trim();
            const notes = document.getElementById('supplierNotes').value.trim();
            
            const suppliers = getSuppliersDatabase();
            suppliers[supplierName] = {
                name: supplierName,
                phone: phone,
                address: address,
                notes: notes,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('suppliersDatabase', JSON.stringify(suppliers));
            closeSupplierModal();
            loadSuppliers();
            showNotification('تم إضافة المورد بنجاح!');
        };

        function getUniqueSuppliers() {
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            const suppliers = [...new Set(purchases.map(p => p.supplierName))].filter(name => name);
            return suppliers.sort();
        }

        function filterSuppliers() {
            const input = document.getElementById('supplierName').value.toLowerCase();
            const dropdown = document.getElementById('supplierDropdown');
            const suppliers = getUniqueSuppliers();
            
            if (input.length === 0) {
                dropdown.innerHTML = '';
                dropdown.style.display = 'none';
                return;
            }
            
            const filtered = suppliers.filter(supplier => 
                supplier.toLowerCase().startsWith(input)
            );
            
            if (filtered.length > 0) {
                dropdown.innerHTML = filtered.map(supplier => 
                    `<div class="client-option" onclick="selectSupplier('${supplier}')">${supplier}</div>`
                ).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function showSupplierList() {
            const input = document.getElementById('supplierName').value;
            if (input.length === 0) {
                const dropdown = document.getElementById('supplierDropdown');
                const suppliers = getUniqueSuppliers();
                
                if (suppliers.length > 0) {
                    dropdown.innerHTML = suppliers.map(supplier => 
                        `<div class="client-option" onclick="selectSupplier('${supplier}')">${supplier}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                }
            }
        }

        function hideSupplierList() {
            setTimeout(() => {
                document.getElementById('supplierDropdown').style.display = 'none';
            }, 200);
        }

        function selectSupplier(supplierName) {
            document.getElementById('supplierName').value = supplierName;
            document.getElementById('supplierDropdown').style.display = 'none';
        }

        function editSupplier(supplierName) {
            const suppliers = getSuppliersDatabase();
            const supplier = suppliers[supplierName];
            
            if (supplier) {
                document.getElementById('supplierNameInput').value = supplier.name;
                document.getElementById('supplierPhone').value = supplier.phone || '';
                document.getElementById('supplierAddress').value = supplier.address || '';
                document.getElementById('supplierNotes').value = supplier.notes || '';
                
                document.getElementById('supplierModalTitle').textContent = 'تعديل بيانات المورد';
                openSupplierModal();
            }
        }

        function deleteSupplier(supplierName) {
            if (confirm(`هل أنت متأكد من حذف المورد "${supplierName}"؟`)) {
                const suppliers = getSuppliersDatabase();
                delete suppliers[supplierName];
                localStorage.setItem('suppliersDatabase', JSON.stringify(suppliers));
                loadSuppliers();
                showNotification('تم حذف المورد بنجاح!');
            }
        }

        function editPurchase(id) {
            console.log('تعديل المشترى:', id);
        }

        function deletePurchase(id) {
            if (confirm('هل أنت متأكد من حذف هذا المشترى؟')) {
                let purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
                purchases = purchases.filter(p => p.id !== id);
                localStorage.setItem('purchases', JSON.stringify(purchases));
                loadPurchases();
                showNotification('تم حذف المشترى بنجاح!');
            }
        }

        // Modal handlers
        document.getElementById('purchaseModal').onclick = function(e) {
            if (e.target === this) {
                closePurchaseModal();
            }
        };

        document.getElementById('supplierModal').onclick = function(e) {
            if (e.target === this) {
                closeSupplierModal();
            }
        };

        // Budget Management Functions
        function loadBudget() {
            calculateFinancialMetrics();
            loadClientAging();
            loadInventoryValue();
            createRevenueChart();
            updateHealthIndicators();
        }

        function calculateFinancialMetrics() {
            // Calculate Total Assets
            const treasuryBalance = getCurrentBalance();
            const bankBalance = getBankBalance();
            const clientDebts = getClientDebts();
            const totalAssets = treasuryBalance + bankBalance + clientDebts;
            
            // Calculate Total Liabilities
            const supplierDebts = getSupplierDebts();
            const pendingPayroll = getPendingPayroll();
            const totalLiabilities = supplierDebts + pendingPayroll;
            
            // Calculate Net Worth
            const netWorth = totalAssets - totalLiabilities;
            
            document.getElementById('totalAssets').textContent = `${totalAssets.toFixed(2)} ج.م`;
            document.getElementById('totalLiabilities').textContent = `${totalLiabilities.toFixed(2)} ج.م`;
            document.getElementById('netWorth').textContent = `${netWorth.toFixed(2)} ج.م`;
        }

        function getBankBalance() {
            const checks = JSON.parse(localStorage.getItem('checks') || '[]');
            return checks.filter(c => c.status === 'cleared').reduce((sum, c) => sum + parseFloat(c.amount), 0);
        }

        function getClientDebts() {
            const clients = getClientsDatabase();
            return Object.values(clients).reduce((sum, client) => {
                const balance = calculateClientBalance(client.name);
                return sum + (balance > 0 ? balance : 0);
            }, 0);
        }

        function calculateClientBalance(clientName) {
            const client = getClientsDatabase()[clientName];
            if (!client) return 0;
            
            const permissions = JSON.parse(localStorage.getItem('permissions') || '[]')
                .filter(p => p.clientName === clientName);
            const totalSales = permissions.reduce((sum, p) => sum + parseFloat(p.totalPrice), 0);
            const totalPayments = getClientPayments(clientName);
            
            return parseFloat(client.openingBalance || 0) + totalSales - totalPayments;
        }

        function getSupplierDebts() {
            // Simulate supplier debts - in real app this would come from supplier transactions
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            return purchases.reduce((sum, p) => sum + parseFloat(p.totalPrice), 0) * 0.3; // Assume 30% unpaid
        }

        function getPendingPayroll() {
            // Simulate pending payroll - in real app this would come from staff management
            return 25000; // Fixed amount for demo
        }

        function loadClientAging() {
            const clients = getClientsDatabase();
            const agingData = [];
            
            Object.values(clients).forEach(client => {
                const balance = calculateClientBalance(client.name);
                if (balance > 0) {
                    const permissions = JSON.parse(localStorage.getItem('permissions') || '[]')
                        .filter(p => p.clientName === client.name)
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    const lastSale = permissions[0];
                    const daysSinceLastSale = lastSale ? 
                        Math.floor((new Date() - new Date(lastSale.date)) / (1000 * 60 * 60 * 24)) : 0;
                    
                    agingData.push({
                        name: client.name,
                        balance: balance,
                        days: daysSinceLastSale
                    });
                }
            });
            
            agingData.sort((a, b) => b.balance - a.balance);
            
            const agingContainer = document.getElementById('clientAging');
            agingContainer.innerHTML = agingData.slice(0, 5).map(client => `
                <div class="aging-item">
                    <div class="aging-client">
                        <div class="client-avatar">${client.name.charAt(0)}</div>
                        <div class="client-details">
                            <span class="client-name">${client.name}</span>
                            <span class="aging-days">${client.days} يوم</span>
                        </div>
                    </div>
                    <div class="aging-amount">${client.balance.toFixed(2)} ج.م</div>
                </div>
            `).join('');
        }

        function loadInventoryValue() {
            const {start, end} = getCurrentDayRange();
            
            // Calculate sold today
            const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
            const soldToday = permissions
                .filter(p => {
                    const date = new Date(p.date);
                    return date >= start && date < end;
                })
                .reduce((sum, p) => sum + parseFloat(p.volume), 0);
            
            // Calculate purchased today
            const purchases = JSON.parse(localStorage.getItem('purchases') || '[]');
            const purchasedToday = purchases
                .filter(p => {
                    const date = new Date(p.date);
                    return date >= start && date < end;
                })
                .reduce((sum, p) => sum + parseFloat(p.quantity), 0);
            
            const balance = purchasedToday - soldToday;
            
            document.getElementById('soldToday').textContent = `${soldToday.toFixed(1)} م³`;
            document.getElementById('purchasedToday').textContent = `${purchasedToday.toFixed(1)} م³`;
            document.getElementById('inventoryBalance').textContent = `${balance.toFixed(1)} م³`;
        }

        function createRevenueChart() {
            const canvas = document.getElementById('revenueChart');
            const ctx = canvas.getContext('2d');
            
            // Calculate revenue by material type
            const permissions = JSON.parse(localStorage.getItem('permissions') || '[]');
            let senRevenue = 0;
            let adasaRevenue = 0;
            
            permissions.forEach(p => {
                const amount = parseFloat(p.totalPrice);
                if (p.materialType === 'سن') {
                    senRevenue += amount;
                } else if (p.materialType === 'عدسة') {
                    adasaRevenue += amount;
                } else {
                    senRevenue += amount; // Default to sen for old data
                }
            });
            
            const total = senRevenue + adasaRevenue;
            const senPercentage = total > 0 ? (senRevenue / total * 100) : 50;
            const adasaPercentage = total > 0 ? (adasaRevenue / total * 100) : 50;
            
            // Update percentages
            document.getElementById('senPercentage').textContent = `${senPercentage.toFixed(1)}%`;
            document.getElementById('adasaPercentage').textContent = `${adasaPercentage.toFixed(1)}%`;
            
            // Draw donut chart
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 100;
            const innerRadius = 60;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Sen segment
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, (senPercentage / 100) * 2 * Math.PI);
            ctx.arc(centerX, centerY, innerRadius, (senPercentage / 100) * 2 * Math.PI, 0, true);
            ctx.fillStyle = '#00ff88';
            ctx.fill();
            
            // Adasa segment
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, (senPercentage / 100) * 2 * Math.PI, 2 * Math.PI);
            ctx.arc(centerX, centerY, innerRadius, 2 * Math.PI, (senPercentage / 100) * 2 * Math.PI, true);
            ctx.fillStyle = '#ff0066';
            ctx.fill();
            
            // Center text
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('الإيرادات', centerX, centerY - 5);
            ctx.font = '12px Arial';
            ctx.fillText(`${total.toFixed(0)} ج.م`, centerX, centerY + 15);
        }

        function updateHealthIndicators() {
            const assets = parseFloat(document.getElementById('totalAssets').textContent.replace(' ج.م', ''));
            const liabilities = parseFloat(document.getElementById('totalLiabilities').textContent.replace(' ج.م', ''));
            const netWorth = parseFloat(document.getElementById('netWorth').textContent.replace(' ج.م', ''));
            
            // Liquidity Ratio
            const liquidityRatio = liabilities > 0 ? (assets / liabilities * 100) : 100;
            document.getElementById('liquidityRatio').textContent = `${liquidityRatio.toFixed(1)}%`;
            
            // Debt Ratio
            const debtRatio = assets > 0 ? (liabilities / assets * 100) : 0;
            document.getElementById('debtRatio').textContent = `${debtRatio.toFixed(1)}%`;
            
            // Profit Margin (simplified)
            const totalRevenue = JSON.parse(localStorage.getItem('permissions') || '[]')
                .reduce((sum, p) => sum + parseFloat(p.totalPrice), 0);
            const profitMargin = totalRevenue > 0 ? (netWorth / totalRevenue * 100) : 0;
            document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(1)}%`;
            
            // Growth Rate (simplified - comparing to last month)
            document.getElementById('growthRate').textContent = '+15.2%';
        }

        function generateCEOReport() {
            const reportData = {
                date: new Date().toLocaleDateString('ar-EG'),
                assets: document.getElementById('totalAssets').textContent,
                liabilities: document.getElementById('totalLiabilities').textContent,
                netWorth: document.getElementById('netWorth').textContent,
                liquidityRatio: document.getElementById('liquidityRatio').textContent,
                debtRatio: document.getElementById('debtRatio').textContent,
                profitMargin: document.getElementById('profitMargin').textContent,
                growthRate: document.getElementById('growthRate').textContent
            };
            
            // Create PDF content (simplified)
            const pdfContent = `
                تقرير المدير التنفيذي - شركة البصيرة
                تاريخ التقرير: ${reportData.date}
                
                المؤشرات المالية الرئيسية:
                - إجمالي الأصول: ${reportData.assets}
                - إجمالي الخصوم: ${reportData.liabilities}
                - صافي الثروة: ${reportData.netWorth}
                
                مؤشرات الأداء:
                - نسبة السيولة: ${reportData.liquidityRatio}
                - نسبة الديون: ${reportData.debtRatio}
                - هامش الربح: ${reportData.profitMargin}
                - معدل النمو: ${reportData.growthRate}
            `;
            
            // Download as text file (in real app, use PDF library)
            const blob = new Blob([pdfContent], {type: 'text/plain;charset=utf-8'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CEO-Report-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            
            showNotification('تم إنشاء تقرير المدير التنفيذي!');
        }

        function exportBudgetData() {
            const budgetData = {
                timestamp: new Date().toISOString(),
                assets: document.getElementById('totalAssets').textContent,
                liabilities: document.getElementById('totalLiabilities').textContent,
                netWorth: document.getElementById('netWorth').textContent,
                healthIndicators: {
                    liquidity: document.getElementById('liquidityRatio').textContent,
                    debt: document.getElementById('debtRatio').textContent,
                    profit: document.getElementById('profitMargin').textContent,
                    growth: document.getElementById('growthRate').textContent
                }
            };
            
            const blob = new Blob([JSON.stringify(budgetData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `budget-data-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showNotification('تم تصدير بيانات الميزانية!');
        }
    </script>
</body>
</html>